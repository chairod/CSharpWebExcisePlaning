/**
 * สร้าง View ค่าคงที่ในระบบ โดยการรวมข้อมูล 2 ตารางได้แก่
 * T_CONFIGURATIONS, T_CONFIGURATION_DETAIL
**/
IF OBJECT_ID('dbo.V_GET_CONFIGURATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_CONFIGURATION;
GO
CREATE VIEW V_GET_CONFIGURATION AS
SELECT CD.CONFIG_DETAIL_ID

, CD.CONFIG_ID, C.CONFIG_NAME, C.CONFIG_DESCRIPTION
, C.CONFIG_CONST

, CD.ITEM_VALUE, CD.ITEM_VALUE2, CD.ITEM_VALUE3
, EFFECTIVE_DATE, EXPIRE_DATE, CD.ACTIVE, CD.CREATED_DATETIME, CD.USER_ID, CD.UPDATED_DATETIME, CD.UPDATED_ID
, CD.ITEM_DESCRIPTION
FROM T_CONFIGURATION C, T_CONFIGURATION_DETAIL CD
WHERE C.CONFIG_ID = CD.CONFIG_ID
GO
sp_refreshview @viewname = 'V_GET_CONFIGURATION'
GO

/**
 * ค้นหาค่าคงที่ ที่ใช้งานอยู่ ณ ปัจจุบัน
 * หมายเหตุ: การกำหนดค่าคงที่ในแต่ละประเภท จะเก็บหลายรายการ ซึ่งกำหนดเป็นแต่ละช่วงเวลาใช้งาน
 * ทำให้จำเป็นต้องดึงเฉพาะรายการ ที่ Active (ใช้งานอยู่) มา
**/
IF OBJECT_ID('dbo.V_GET_CURR_CONFIGURATION_USING', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_CURR_CONFIGURATION_USING;
GO
CREATE VIEW V_GET_CURR_CONFIGURATION_USING AS
	SELECT * FROM(
		SELECT CONFIG_ID, CONFIG_CONST,
		(SELECT TOP 1 CONFIG_DETAIL_ID 
		FROM V_GET_CONFIGURATION  CD
		WHERE ACTIVE = 1 
		AND 
		(
			-- ยังไม่กำหนด Expire Date
			(EXPIRE_DATE IS NULL AND CONVERT(DATE, GETDATE()) >= EFFECTIVE_DATE) OR 
			-- กำหนด Expire Date แล้ว
			(EXPIRE_DATE IS NOT NULL AND CONVERT(DATE, GETDATE()) BETWEEN EFFECTIVE_DATE AND EXPIRE_DATE)
		)
		AND CD.CONFIG_ID = C.CONFIG_ID
		ORDER BY CD.EFFECTIVE_DATE DESC) AS CONFIG_DETAIL_ID
		FROM T_CONFIGURATION C
		WHERE ACTIVE = 1
	) AS A WHERE CONFIG_DETAIL_ID IS NOT NULL
	;
GO
sp_refreshview @viewname = 'V_GET_CURR_CONFIGURATION_USING'
GO


/**
 * View แสดงผลการกำหนดอัตราค่าเช่าบ้าน
**/
IF OBJECT_ID('dbo.V_GET_RENT_HOUSE_RATE_CONFIGURE', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_RENT_HOUSE_RATE_CONFIGURE;
GO
CREATE VIEW V_GET_RENT_HOUSE_RATE_CONFIGURE AS
	SELECT * ,
	LEVEL_NAME = (SELECT TOP 1 LEVEL_NAME FROM T_PERSONNEL_LEVEL P WHERE T.LEVEL_ID = P.LEVEL_ID)
	FROM T_RENT_HOUSE_RATE_CONFIGURE T
	;
GO
sp_refreshview @viewname = 'V_GET_RENT_HOUSE_RATE_CONFIGURE'
GO


/**
 *  View ข้อมูลภาพรวมของบุคลากร
 *
**/
IF OBJECT_ID('dbo.V_GET_PERSONNEL_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_PERSONNEL_INFORMATION;
GO
CREATE VIEW V_GET_PERSONNEL_INFORMATION AS
	SELECT PERSON_ID, PERSON_CODE, PREFIX_NAME, FIRST_NAME, LAST_NAME, CARD_NUMBER
	  , SALARY
	  , LEVEL_ID, (SELECT TOP 1 LEVEL_NAME FROM T_PERSONNEL_LEVEL PERSON_LEVEL WHERE PERSON_LEVEL.LEVEL_ID = PERSON.LEVEL_ID) AS LEVEL_NAME
	  , DEP_ID, (SELECT TOP 1 DEP_NAME FROM T_DEPARTMENT DEPARTMENT WHERE DEPARTMENT.DEP_ID = PERSON.DEP_ID) AS DEP_NAME
	  , SUB_DEP_ID, (SELECT TOP 1 SUB_DEP_NAME FROM T_SUB_DEPARTMENT SUB_DEP WHERE SUB_DEP.SUB_DEP_ID = PERSON.SUB_DEP_ID) as SUB_DEP_NAME
	  , POSITION_ID, (SELECT TOP 1 POSITION_NAME FROM T_POSITION POSITION WHERE POSITION.POSITION_ID = PERSON.POSITION_ID) AS POSITION_NAME
	  , PERSON_TYPE_ID, (SELECT TOP 1 ITEM_TEXT FROM T_PERSONNEL_TYPE PERSON_TYPE WHERE PERSON_TYPE.PERSON_TYPE_ID = PERSON.PERSON_TYPE_ID) AS PERSON_TYPE_NAME
	  , REGISTER_DATE, EMAIL_ADDR, SEX_TYPE, ACC_TYPE, LAST_LOGIN_DATETIME
	  , ACTIVE, CREATED_DATETIME
	  , AREA_ID, (Select top 1 AREA_NAME from T_AREA R where R.AREA_ID = PERSON.AREA_ID) AS AREA_NAME
	  , STREET, VILLAGE, DISTRICT, PREFEXTURE, PROVINCE_NAME, POST_CODE, ADDRESS
	FROM T_PERSONNEL PERSON
GO
sp_refreshview @viewname = 'V_GET_PERSONNEL_INFORMATION'
GO



/**
 * View แสดงข้อมูล template คำขอเงิน งปม.
 *
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_TEMPLATE_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_TEMPLATE_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_TEMPLATE_INFORMATION AS
	SELECT TEMPLATE.*
	
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = TEMPLATE.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = TEMPLATE.PLAN_ID) AS PLAN_ORDER_SEQ

	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = TEMPLATE.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = TEMPLATE.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = TEMPLATE.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = TEMPLATE.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE X WHERE X.BUDGET_TYPE_ID = TEMPLATE.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE X WHERE X.BUDGET_TYPE_ID = TEMPLATE.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = TEMPLATE.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = TEMPLATE.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ
	
	-- รายการค่าใช้จ่าย ที่อยู่ในกลุ่ม Template
	-- , TEMPLATE_EXPENSES.EXPENSES_ID
	-- , (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES WHERE EXPENSES.EXPENSES_ID = TEMPLATE_EXPENSES.EXPENSES_ID) AS EXPENSES_NAME
	FROM T_BUDGET_REQUEST_TEMPLATE TEMPLATE--, T_BUDGET_REQUEST_TEMPLATE_EXPENSES TEMPLATE_EXPENSES
	WHERE TEMPLATE.ACTIVE = 1
	--  AND TEMPLATE.TEMPLATE_ID = TEMPLATE_EXPENSES.TEMPLATE_ID;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_TEMPLATE_INFORMATION'
GO


/**
 * View แสดงข้อมูลรายการค่าใช้จ่ายที่ถูกกำหนดไว้ใน template คำขอเงิน งปม.
 *
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_TEMPLATE_EXPENSES_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_TEMPLATE_EXPENSES_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_TEMPLATE_EXPENSES_INFORMATION AS
	SELECT MAS_TEMPLATE.TEMPLATE_ID, MAS_TEMPLATE.TEMPLATE_NAME, MAS_TEMPLATE.CREATE_TYPE
	, MAS_TEMPLATE.SHARED_DEP_TEMPLATE, MAS_TEMPLATE.SHARED_YR_TEMPLATE
	, MAS_TEMPLATE.ACTIVE, MAS_TEMPLATE.CREATED_DATETIME, MAS_TEMPLATE.USER_ID
	, MAS_TEMPLATE.UPDATED_DATETIME, MAS_TEMPLATE.UPDATED_ID

	, MAS_TEMPLATE.FOR_BUDGET, MAS_TEMPLATE.FOR_OFF_BUDGET
	
	, MAS_TEMPLATE.PLAN_ID
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = MAS_TEMPLATE.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = MAS_TEMPLATE.PLAN_ID) AS PLAN_ORDER_SEQ

	, MAS_TEMPLATE.PRODUCE_ID
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = MAS_TEMPLATE.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = MAS_TEMPLATE.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

	, MAS_TEMPLATE.ACTIVITY_ID
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = MAS_TEMPLATE.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = MAS_TEMPLATE.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ


	--, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE X WHERE X.BUDGET_TYPE_ID = MAS_TEMPLATE.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	--, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = MAS_TEMPLATE.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	---- รายการค่าใช้จ่ายที่กำหนดไว้ใน Template
	--, EXPENSES_TEMPLATE.EXPENSES_ID
	--, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES WHERE EXPENSES.EXPENSES_ID = EXPENSES_TEMPLATE.EXPENSES_ID) AS EXPENSES_NAME

	-- ใช้ข้อมูลจากรายการค่าใช้จ่าย ในการหา งบรายจ่าย, หมวดค่าใช้จ่าย
	-- เผื่อในกรณีที่มีการเปลี่ยนแปลงข้อมูลส่วน Master ของค่าใช้จ่าย (จะทำให้ข้อมูล งบรายจ่าย และ หมวดค่าใช้จ่าย ใน Template ไม่ถูกต้อง)
	, EXPENSES_ITEM.BUDGET_TYPE_ID, EXPENSES_ITEM.BUDGET_TYPE_NAME, EXPENSES_ITEM.BUDGET_TYPE_ORDER_SEQ
	, EXPENSES_ITEM.EXPENSES_MASTER_NAME
	, EXPENSES_ITEM.EXPENSES_GROUP_ID, EXPENSES_ITEM.EXPENSES_GROUP_NAME, EXPENSES_ITEM.EXPENSES_GROUP_ORDER_SEQ
	, EXPENSES_ITEM.EXPENSES_ID, EXPENSES_ITEM.EXPENSES_NAME, EXPENSES_ITEM.EXPENSES_ORDER_SEQ

	FROM T_BUDGET_REQUEST_TEMPLATE MAS_TEMPLATE
	, T_BUDGET_REQUEST_TEMPLATE_EXPENSES EXPENSES_TEMPLATE
	, V_GET_EXPENSES_ITEM EXPENSES_ITEM
	WHERE MAS_TEMPLATE.ACTIVE = 1
	  AND MAS_TEMPLATE.TEMPLATE_ID = EXPENSES_TEMPLATE.TEMPLATE_ID
	  AND EXPENSES_TEMPLATE.EXPENSES_ID = EXPENSES_ITEM.EXPENSES_ID;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_TEMPLATE_EXPENSES_INFORMATION'
GO

/**
 * View แสดงข้อมูล หมวดค่าใช้จ่าย
 *
**/
IF OBJECT_ID('dbo.V_GET_EXPENSES_GROUP_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_EXPENSES_GROUP_INFORMATION;
GO
CREATE VIEW V_GET_EXPENSES_GROUP_INFORMATION AS
	SELECT EXPENSES_GROUP.*
	, (SELECT EXPENSES_MASTER_NAME FROM T_EXPENSES_MASTER X WHERE X.EXPENSES_MASTER_ID = EXPENSES_GROUP.EXPENSES_MASTER_ID) AS EXPENSES_MASTER_NAME
	, (Select BUDGET_TYPE_NAME from T_BUDGET_TYPE B where B.BUDGET_TYPE_ID = EXPENSES_GROUP.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (Select ORDER_SEQ from T_BUDGET_TYPE B where B.BUDGET_TYPE_ID = EXPENSES_GROUP.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ
	-- รายการค่าใช้จ่าย ที่อยู่ในกลุ่ม Template
	-- , TEMPLATE_EXPENSES.EXPENSES_ID
	-- , (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES WHERE EXPENSES.EXPENSES_ID = TEMPLATE_EXPENSES.EXPENSES_ID) AS EXPENSES_NAME
	FROM T_EXPENSES_GROUP EXPENSES_GROUP--, T_BUDGET_REQUEST_TEMPLATE_EXPENSES TEMPLATE_EXPENSES
	WHERE EXPENSES_GROUP.ACTIVE = 1
	--  AND TEMPLATE.TEMPLATE_ID = TEMPLATE_EXPENSES.TEMPLATE_ID;
GO
sp_refreshview @viewname = 'V_GET_EXPENSES_GROUP_INFORMATION'
GO

/**
 * View แสดงข้อมูล หมวดค่าใช้จ่าย
 *
**/
IF OBJECT_ID('dbo.V_GET_EXPENSES_ITEM', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_EXPENSES_ITEM;
GO
CREATE VIEW V_GET_EXPENSES_ITEM AS
	SELECT EXPENSES_ITEM.EXPENSES_ID, EXPENSES_ITEM.EXPENSES_GROUP_ID
	, RTRIM(EXPENSES_ITEM.EXPENSES_NAME) AS EXPENSES_NAME
	, EXPENSES_ITEM.ORDER_SEQ as EXPENSES_ORDER_SEQ
	, EXPENSES_ITEM.FORM_TEMPLATE_NAME
	, EXPENSES_ITEM.ACTIVE, EXPENSES_ITEM.CREATED_DATETIME, EXPENSES_ITEM.USER_ID
	, EXPENSES_ITEM.UPDATED_DATETIME, EXPENSES_ITEM.UPDATED_ID
	, EXPENSES_ITEM.CAN_ADD_PROJECT

	-- ข้อมูลหมวดค่าใช้จ่าย
	, EXPENSES_GROUP.EXPENSES_MASTER_ID, EXPENSES_GROUP.EXPENSES_MASTER_NAME
	, EXPENSES_GROUP.BUDGET_TYPE_ID, EXPENSES_GROUP.BUDGET_TYPE_NAME, EXPENSES_GROUP.BUDGET_TYPE_ORDER_SEQ
	, EXPENSES_GROUP.EXPENSES_GROUP_NAME, EXPENSES_GROUP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
	FROM T_EXPENSES_ITEM EXPENSES_ITEM, V_GET_EXPENSES_GROUP_INFORMATION EXPENSES_GROUP
	WHERE EXPENSES_ITEM.EXPENSES_GROUP_ID = EXPENSES_GROUP.EXPENSES_GROUP_ID
GO
sp_refreshview @viewname = 'V_GET_EXPENSES_ITEM'
GO


/**
 * View แสดงข้อมูลรายการ คชจ.
 *
**/
IF OBJECT_ID('dbo.V_GET_EXPENSES_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_EXPENSES_INFORMATION;
GO
CREATE VIEW V_GET_EXPENSES_INFORMATION AS
	SELECT EXPENSES.*
	-- , (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = EXPENSES.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, EXPENSES_GROUP.BUDGET_TYPE_ID, EXPENSES_GROUP.BUDGET_TYPE_NAME, EXPENSES_GROUP.BUDGET_TYPE_ORDER_SEQ
	, EXPENSES_GROUP.EXPENSES_MASTER_ID, EXPENSES_GROUP.EXPENSES_MASTER_NAME
	, EXPENSES_GROUP.EXPENSES_GROUP_NAME, EXPENSES_GROUP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
	FROM T_EXPENSES_ITEM EXPENSES, V_GET_EXPENSES_GROUP_INFORMATION EXPENSES_GROUP
	WHERE EXPENSES.ACTIVE = 1
	  AND EXPENSES.EXPENSES_GROUP_ID = EXPENSES_GROUP.EXPENSES_GROUP_ID
GO
sp_refreshview @viewname = 'V_GET_EXPENSES_INFORMATION'
GO



/**
 * View ภาพรวมเงินงบประมาณของกรมสรรพสามิต
**/
IF OBJECT_ID('dbo.V_GET_SUMMARY_OVERALL_BUDGET', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_SUMMARY_OVERALL_BUDGET;
GO
CREATE VIEW V_GET_SUMMARY_OVERALL_BUDGET AS
	
	SELECT BUDGET.*
	, (SELECT SUM(TOTAL_REQUEST_BUDGET) FROM T_BUDGET_REQUEST_MASTER REQ_MAS WHERE REQ_MAS.YR = BUDGET.YR AND REQ_MAS.REQ_TYPE = 1 AND REQ_MAS.ACTIVE = 1) AS REQUEST_BUDGET_START_YEAR_AMOUNT
	-- กันเงิน หน่วยงานภายในกรมสรรพสามิต ของแต่ละ คชจ./โครงการ
	, BUDGET_RESERVE.RESERVE_BUDGET_AMOUNT
	, BUDGET_RESERVE.RESERVE_USE_BUDGET_AMOUNT
	, BUDGET_RESERVE.RESERVE_REMAIN_BUDGET_AMOUNT

	, BUDGET_RESERVE.RESERVE_OFF_BUDGET_AMOUNT
	, BUDGET_RESERVE.RESERVE_USE_OFF_BUDGET_AMOUNT
	, BUDGET_RESERVE.RESERVE_REMAIN_OFF_BUDGET_AMOUNT

	-- จัดสรรงบประมาณให้หน่วยงานภูมิภาค - ตามรายการค่าใช้จ่าย/โครงการ
	, BUDGET_ALLOCATE.DEP_ALLOCATE_BUDGET_AMOUNT
	, BUDGET_ALLOCATE.DEP_USE_BUDGET_AMOUNT
	, BUDGET_ALLOCATE.DEP_ALLOCATE_OFF_BUDGET_AMOUNT
	, BUDGET_ALLOCATE.DEP_USE_OFF_BUDGET_AMOUNT
	-- จัดสรรงบประมาณให้หน่วยงานภูมิภาค - เป็นก้อนตามหมวดค่าใช้จ่าย
	, BUDGET_ALLOCATE_GRP.DEP_GRP_ALLOCATE_BUDGET_AMOUNT
	, BUDGET_ALLOCATE_GRP.DEP_GRP_ALLOCATE_OFF_BUDGET_AMOUNT
	FROM (
		SELECT BUDGET_MAS.BUDGET_ID, BUDGET_MAS.YR
		, BUDGET_MAS.TEMPORARY_YR -- ปีงบประมาณพลางก่อน
		, BUDGET_MAS.BUDGET_FLAG -- 1 = งบประมาณปกติ, 2 = พลางก่อน
	
		-- เงินงบประมาณ และ เงินประจำงวดของกรมสรรพสามิต
		, BUDGET_MAS.ALLOCATE_BUDGET_AMOUNT AS MAS_ALLOCATE_BUDGET_AMOUNT
		, BUDGET_MAS.ACTUAL_BUDGET_AMOUNT AS MAS_ACTUAL_BUDGET_AMOUNT
		, BUDGET_MAS.USE_BUDGET_AMOUNT AS MAS_USE_BUDGET_AMOUNT
		, BUDGET_MAS.REMAIN_BUDGET_AMOUNT AS MAS_REMAIN_BUDGET_AMOUNT

		-- เงินนอกงบประมาณ และ จัดเก็บรายได้ของกรมสรรพสามิต
		, BUDGET_MAS.OFF_BUDGET_SPREAD_TO_EXPENSES -- กระจายเงินงวด ลงในรายการค่าใช้จ่าย
		, BUDGET_MAS.ALLOCATE_OFF_BUDGET_AMOUNT AS MAS_ALLOCATE_OFF_BUDGET_AMOUNT
		, BUDGET_MAS.ACTUAL_OFF_BUDGET_AMOUNT AS MAS_ACTUAL_OFF_BUDGET_AMOUNT
		, BUDGET_MAS.USE_OFF_BUDGET_AMOUNT AS MAS_USE_OFF_BUDGET_AMOUNT
		, BUDGET_MAS.REMAIN_OFF_BUDGET_AMOUNT AS MAS_REMAIN_OFF_BUDGET_AMOUNT

		-- รายการค่าใช้จ่าย
		, BUDGET_EX.PLAN_ID, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_NAME
		, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE X WHERE X.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_ORDER_SEQ

		, BUDGET_EX.PRODUCE_ID, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_NAME
		, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE X WHERE X.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

		, BUDGET_EX.ACTIVITY_ID, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_NAME
		, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE X WHERE X.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

		, BUDGET_EX.BUDGET_TYPE_ID, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE X WHERE X.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
		, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE X WHERE X.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ
		, dbo.fn_GetBudgetTypeGovenmentReferCode(BUDGET_EX.BUDGET_TYPE_ID, NULL) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
		, dbo.fn_GetBudgetTypeShareBudget(BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_SHARED_BUDGET

		, BUDGET_EX.EXPENSES_GROUP_ID
		, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ
		, (SELECT ALLOCATE_GROUP_FLAG FROM T_EXPENSES_GROUP X WHERE X.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ALLOCATE_GROUP_FLAG
		, dbo.fn_GetExpensesGroupGovenmentReferCode(BUDGET_EX.EXPENSES_GROUP_ID, NULL) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE
		
		, BUDGET_EX.EXPENSES_ID, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM X WHERE X.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM X WHERE X.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_ORDER_SEQ

		, GLCODEs = dbo.fn_GetExpensesGLCodes(BUDGET_EX.EXPENSES_ID)
		, BUDGET_EX.CAN_ADD_PROJECT -- รายการค่าใช้จ่ายนี้ สามารถเพิ่มโครงการย่อยภายใต้ได้หรือไม่ (ไม่ได้หยิบมาจาก Expenses_item)
		, BUDGET_EX.PROJECT_ID, BUDGET_EX.PROJECT_NAME
		, BUDGET_EX.PROJECT_FOR_TYPE -- 1 = โครงการของเงินงบประมาณ, 2 = โครงการของเงินนอกงบประมาณ

		-- งบประมาณส่วนของค่าใช้จ่าย
		, BUDGET_EX.BUDGET_AMOUNT
		, BUDGET_EX.ACTUAL_BUDGET_AMOUNT
		, BUDGET_EX.USE_BUDGET_AMOUNT
		, BUDGET_EX.REMAIN_BUDGET_AMOUNT

		, BUDGET_EX.OFF_BUDGET_AMOUNT
		, BUDGET_EX.ACTUAL_OFF_BUDGET_AMOUNT
		, BUDGET_EX.USE_OFF_BUDGET_AMOUNT
		, BUDGET_EX.REMAIN_OFF_BUDGET_AMOUNT

		-- งบประมาณส่วนของโครงการภายใต้รายการค่าใช้จ่าย
		, BUDGET_EX.PRO_BUDGET_AMOUNT
		, BUDGET_EX.PRO_ACTUAL_BUDGET_AMOUNT
		, BUDGET_EX.PRO_USE_BUDGET_AMOUNT
		, BUDGET_EX.PRO_REMAIN_BUDGET_AMOUNT

		, BUDGET_EX.PRO_OFF_BUDGET_AMOUNT
		, BUDGET_EX.PRO_ACTUAL_OFF_BUDGET_AMOUNT
		, BUDGET_EX.PRO_USE_OFF_BUDGET_AMOUNT
		, BUDGET_EX.PRO_REMAIN_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_MASTER BUDGET_MAS
		, (
			-- ข้อมูลรายการค่าใช้จ่าย ที่ยกเว้นส่วนของโครงการ
			SELECT BUDGET_EX.*
			, CAST(NULL AS INT) AS PROJECT_ID
			, CAST(NULL AS NVARCHAR) AS PROJECT_NAME, CAST(NULL AS SMALLINT) AS PROJECT_FOR_TYPE
			-- งบประมาณส่วนของโครงการ (ภายใต้รายการค่าใช้จ่าย)
			, CAST(NULL AS DECIMAL) AS PRO_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_ACTUAL_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_USE_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_REMAIN_BUDGET_AMOUNT

			, CAST(NULL AS DECIMAL) AS PRO_OFF_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_ACTUAL_OFF_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_USE_OFF_BUDGET_AMOUNT
			, CAST(NULL AS DECIMAL) AS PRO_REMAIN_OFF_BUDGET_AMOUNT
			FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX

			UNION 

			-- ข้อมูลรายการค่าใช้จ่ายที่ ประกอบด้วยโครงการที่อยู่ภายใต้ค่าใช้จ่าย
			SELECT BUDGET_EX.*, BUDGET_PRO.PROJECT_ID, BUDGET_PRO.PROJECT_NAME, BUDGET_PRO.PROJECT_FOR_TYPE
			-- งบประมาณส่วนของโครงการ (ภายใต้รายการค่าใช้จ่าย)
			, BUDGET_PRO.BUDGET_AMOUNT AS PRO_BUDGET_AMOUNT
			, BUDGET_PRO.ACTUAL_BUDGET_AMOUNT AS PRO_ACTUAL_BUDGET_AMOUNT
			, BUDGET_PRO.USE_BUDGET_AMOUNT AS PRO_USE_BUDGET_AMOUNT
			, BUDGET_PRO.REMAIN_BUDGET_AMOUNT AS PRO_REMAIN_BUDGET_AMOUNT

			, BUDGET_PRO.OFF_BUDGET_AMOUNT AS PRO_OFF_BUDGET_AMOUNT
			, BUDGET_PRO.ACTUAL_OFF_BUDGET_AMOUNT AS PRO_ACTUAL_OFF_BUDGET_AMOUNT
			, BUDGET_PRO.USE_OFF_BUDGET_AMOUNT AS PRO_USE_OFF_BUDGET_AMOUNT
			, BUDGET_PRO.REMAIN_OFF_BUDGET_AMOUNT AS PRO_REMAIN_OFF_BUDGET_AMOUNT
			FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX
			LEFT JOIN (SELECT * FROM T_BUDGET_EXPENSES_PROJECT WHERE ACTIVE = 1) AS BUDGET_PRO
			ON(
				BUDGET_EX.BUDGET_ID = BUDGET_PRO.BUDGET_ID AND
				BUDGET_EX.PLAN_ID = BUDGET_PRO.PLAN_ID AND
				BUDGET_EX.PRODUCE_ID = BUDGET_PRO.PRODUCE_ID AND
				BUDGET_EX.ACTIVITY_ID = BUDGET_PRO.ACTIVITY_ID AND
				BUDGET_EX.BUDGET_TYPE_ID = BUDGET_PRO.BUDGET_TYPE_ID AND
				BUDGET_EX.EXPENSES_GROUP_ID = BUDGET_PRO.EXPENSES_GROUP_ID AND
				BUDGET_EX.EXPENSES_ID = BUDGET_PRO.EXPENSES_ID
			)

		) AS  BUDGET_EX
		WHERE BUDGET_MAS.BUDGET_ID = BUDGET_EX.BUDGET_ID
	) AS BUDGET

	-- ข้อมูลการเบิกจ่ายหน่วยงานภายในกรมสรรพสามิต
	LEFT JOIN (
		SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
		, SUM(CASE WHEN BUDGET_TYPE = 1 THEN RESERVE_BUDGET_AMOUNT ELSE 0 END) AS RESERVE_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 1 THEN USE_AMOUNT ELSE 0 END) AS RESERVE_USE_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 1 THEN REMAIN_AMOUNT ELSE 0 END) AS RESERVE_REMAIN_BUDGET_AMOUNT

		, SUM(CASE WHEN BUDGET_TYPE = 2 THEN RESERVE_BUDGET_AMOUNT ELSE 0 END) AS RESERVE_OFF_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 2 THEN USE_AMOUNT ELSE 0 END) AS RESERVE_USE_OFF_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 2 THEN REMAIN_AMOUNT ELSE 0 END) AS RESERVE_REMAIN_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_RESERVE
		-- ไม่ต้องใช้เงื่อนไข Active = 1
		-- ใบกันเงินบางรายการที่ถูกยกเลิก (Active = -1) อาจมีการเบิกจ่ายไปแล้ว ดังนั้น จะมียอดกันเงินซึ่งจะต้องทำยอดนั้นมาแสดงผลด้วย
		-- WHERE ACTIVE = 1
		GROUP BY YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
	) AS BUDGET_RESERVE
	ON(
		BUDGET_RESERVE.YR = BUDGET.YR AND
		BUDGET_RESERVE.PLAN_ID = BUDGET.PLAN_ID AND
		BUDGET_RESERVE.PRODUCE_ID = BUDGET.PRODUCE_ID AND
		BUDGET_RESERVE.ACTIVITY_ID = BUDGET.ACTIVITY_ID AND
		BUDGET_RESERVE.BUDGET_TYPE_ID = BUDGET.BUDGET_TYPE_ID AND
		BUDGET_RESERVE.EXPENSES_GROUP_ID = BUDGET.EXPENSES_GROUP_ID AND
		BUDGET_RESERVE.EXPENSES_ID = BUDGET.EXPENSES_ID AND
		(
			-- รายการค่าใช้จ่าย มี โครงการย่อย (ไม่สามารถใช้ NULL equals NULL ใน SQL SERVER ได้)
			(BUDGET_RESERVE.PROJECT_ID = BUDGET.PROJECT_ID) OR
			-- รายการค่าใช้จ่าย ที่ไม่มี โครงการย่อย
			(BUDGET.PROJECT_ID IS NULL AND BUDGET_RESERVE.PROJECT_ID IS NULL) -- OR
			-- มีการจัดสรรให้หน่วยงานภูมิภาคแล้ว และเพิ่มโครงการในภายหลัง
			-- (BUDGET.PROJECT_ID IS NOT NULL AND BUDGET_RESERVE.PROJECT_ID IS NULL)
		)
	)

	-- ข้อมูลการจัดสรรงบประมาณให้หน่วยงานภูมิภาค - ตามรายการค่าใช้จ่าย
	LEFT JOIN
	(
		SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID
		, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
		, PROJECT_ID
		, SUM(ALLOCATE_BUDGET_AMOUNT) AS DEP_ALLOCATE_BUDGET_AMOUNT
		, SUM(USE_BUDGET_AMOUNT) AS DEP_USE_BUDGET_AMOUNT
		, SUM(ALLOCATE_OFF_BUDGET_AMOUNT) AS DEP_ALLOCATE_OFF_BUDGET_AMOUNT
		, SUM(USE_OFF_BUDGET_AMOUNT) AS DEP_USE_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_ALLOCATE_EXPENSES 
		WHERE ACTIVE = 1
		GROUP BY YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
	) AS BUDGET_ALLOCATE
	ON(
		BUDGET_ALLOCATE.YR = BUDGET.YR AND
		BUDGET_ALLOCATE.PLAN_ID = BUDGET.PLAN_ID AND
		BUDGET_ALLOCATE.PRODUCE_ID = BUDGET.PRODUCE_ID AND
		BUDGET_ALLOCATE.ACTIVITY_ID = BUDGET.ACTIVITY_ID AND
		BUDGET_ALLOCATE.BUDGET_TYPE_ID = BUDGET.BUDGET_TYPE_ID AND
		BUDGET_ALLOCATE.EXPENSES_GROUP_ID = BUDGET.EXPENSES_GROUP_ID AND
		BUDGET_ALLOCATE.EXPENSES_ID = BUDGET.EXPENSES_ID AND
		(
			-- รายการค่าใช้จ่าย มี โครงการย่อย (ไม่สามารถใช้ NULL equals NULL ใน SQL SERVER ได้)
			(BUDGET_ALLOCATE.PROJECT_ID = BUDGET.PROJECT_ID) OR
			-- รายการค่าใช้จ่าย ที่ไม่มี โครงการย่อย
			(BUDGET.PROJECT_ID IS NULL AND BUDGET_ALLOCATE.PROJECT_ID IS NULL) --OR
			-- มีการจัดสรรให้หน่วยงานภูมิภาคแล้ว และเพิ่มโครงการในภายหลัง
			--(BUDGET.PROJECT_ID IS NOT NULL AND BUDGET_ALLOCATE.PROJECT_ID IS NULL)
		)
	)

	-- ข้อมูลการจัดสรรงบประมาณให้หน่วยงานภูมิภาค - เป็นก้อนตามหมวดค่าใช้จ่าย
	LEFT JOIN (
		SELECT YR, PLAN_ID, PRODUCE_ID
		, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID
		, SUM(ALLOCATE_BUDGET_AMOUNT) AS DEP_GRP_ALLOCATE_BUDGET_AMOUNT
		, SUM(ALLOCATE_OFF_BUDGET_AMOUNT) AS DEP_GRP_ALLOCATE_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_ALLOCATE_EXPENSES_GROUP 
		WHERE ACTIVE = 1
		GROUP BY  YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID
	) AS BUDGET_ALLOCATE_GRP
	ON(
		BUDGET_ALLOCATE_GRP.YR = BUDGET.YR AND
		BUDGET_ALLOCATE_GRP.PLAN_ID = BUDGET.PLAN_ID AND
		BUDGET_ALLOCATE_GRP.PRODUCE_ID = BUDGET.PRODUCE_ID AND
		BUDGET_ALLOCATE_GRP.ACTIVITY_ID = BUDGET.ACTIVITY_ID AND
		BUDGET_ALLOCATE_GRP.BUDGET_TYPE_ID = BUDGET.BUDGET_TYPE_ID AND
		BUDGET_ALLOCATE_GRP.EXPENSES_GROUP_ID = BUDGET.EXPENSES_GROUP_ID
	)
	;
GO
sp_refreshview @viewname = 'V_GET_SUMMARY_OVERALL_BUDGET'
GO



/**
 * View ข้อมูลรายการค่าใช้จ่าย และ รายละเอียดของรายการค่าใช้จ่าย
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_EXPENSES_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_EXPENSES_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_EXPENSES_INFORMATION AS
	-- ข้อมูลรายการค่าใช้จ่าย ที่ยกเว้นส่วนของโครงการ
	SELECT BUDGET_EX.*
	, CAST(NULL AS INT) AS PROJECT_ID
	, CAST(NULL AS NVARCHAR) AS PROJECT_NAME, CAST(NULL AS SMALLINT) AS PROJECT_FOR_TYPE
	-- งบประมาณส่วนของโครงการ (ภายใต้รายการค่าใช้จ่าย)
	, CAST(NULL AS DECIMAL) AS PRO_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_ACTUAL_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_USE_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_REMAIN_BUDGET_AMOUNT

	, CAST(NULL AS DECIMAL) AS PRO_OFF_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_ACTUAL_OFF_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_USE_OFF_BUDGET_AMOUNT
	, CAST(NULL AS DECIMAL) AS PRO_REMAIN_OFF_BUDGET_AMOUNT
	FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX

	UNION 

	-- ข้อมูลรายการค่าใช้จ่ายที่ ประกอบด้วยโครงการที่อยู่ภายใต้ค่าใช้จ่าย
	SELECT BUDGET_EX.*, BUDGET_PRO.PROJECT_ID, BUDGET_PRO.PROJECT_NAME, BUDGET_PRO.PROJECT_FOR_TYPE
	-- งบประมาณส่วนของโครงการ (ภายใต้รายการค่าใช้จ่าย)
	, BUDGET_PRO.BUDGET_AMOUNT AS PRO_BUDGET_AMOUNT
	, BUDGET_PRO.ACTUAL_BUDGET_AMOUNT AS PRO_ACTUAL_BUDGET_AMOUNT
	, BUDGET_PRO.USE_BUDGET_AMOUNT AS PRO_USE_BUDGET_AMOUNT
	, BUDGET_PRO.REMAIN_BUDGET_AMOUNT AS PRO_REMAIN_BUDGET_AMOUNT

	, BUDGET_PRO.OFF_BUDGET_AMOUNT AS PRO_OFF_BUDGET_AMOUNT
	, BUDGET_PRO.ACTUAL_OFF_BUDGET_AMOUNT AS PRO_ACTUAL_OFF_BUDGET_AMOUNT
	, BUDGET_PRO.USE_OFF_BUDGET_AMOUNT AS PRO_USE_OFF_BUDGET_AMOUNT
	, BUDGET_PRO.REMAIN_OFF_BUDGET_AMOUNT AS PRO_REMAIN_OFF_BUDGET_AMOUNT
	FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX
	LEFT JOIN (SELECT * FROM T_BUDGET_EXPENSES_PROJECT WHERE ACTIVE = 1) AS BUDGET_PRO
	ON(
		BUDGET_EX.BUDGET_ID = BUDGET_PRO.BUDGET_ID AND
		BUDGET_EX.PLAN_ID = BUDGET_PRO.PLAN_ID AND
		BUDGET_EX.PRODUCE_ID = BUDGET_PRO.PRODUCE_ID AND
		BUDGET_EX.ACTIVITY_ID = BUDGET_PRO.ACTIVITY_ID AND
		BUDGET_EX.BUDGET_TYPE_ID = BUDGET_PRO.BUDGET_TYPE_ID AND
		BUDGET_EX.EXPENSES_GROUP_ID = BUDGET_PRO.EXPENSES_GROUP_ID AND
		BUDGET_EX.EXPENSES_ID = BUDGET_PRO.EXPENSES_ID
	)
GO
sp_refreshview @viewname = 'V_GET_BUDGET_EXPENSES_INFORMATION'
GO


/**
 * สร้าง View แสดงการกำหนดสูตรในการคำนวณค่าใช้จ่าย
 * ของการประมาณการรายได้ภาษี
**/
IF OBJECT_ID('dbo.V_GET_TAX_FORCAST_EXPENSES_TYPE_FORMULA_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_TAX_FORCAST_EXPENSES_TYPE_FORMULA_INFORMATION;
GO
CREATE VIEW V_GET_TAX_FORCAST_EXPENSES_TYPE_FORMULA_INFORMATION AS
	SELECT FORCAST_EXPENSES_TYPE.*
	, FORCAST_EXPENSES_TYPE_FORMULA.FORMULA_ID
	, FORCAST_EXPENSES_TYPE_FORMULA.START_DATE
	, FORCAST_EXPENSES_TYPE_FORMULA.EXPIRE_DATE
	, FORCAST_EXPENSES_TYPE_FORMULA.ACTIVE
	, FORCAST_EXPENSES_TYPE_FORMULA.CAL_PRIORITY
	, FORCAST_EXPENSES_TYPE_FORMULA.PERCENT_VAL
	, FORCAST_EXPENSES_TYPE_FORMULA.REMARK_TEXT
	FROM T_TAX_FORCAST_EXPENSES_TYPE FORCAST_EXPENSES_TYPE
	JOIN (
		SELECT A.*, B.CAL_PRIORITY, B.PERCENT_VAL, B.REMARK_TEXT
		FROM T_TAX_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA A
		, T_TAX_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA_DETAIL B
		WHERE A.FORMULA_ID = B.FORMULA_ID
		  AND A.ACTIVE = 1
	) FORCAST_EXPENSES_TYPE_FORMULA
		ON(FORCAST_EXPENSES_TYPE.FORCAST_EXPENSES_TYPE_ID = FORCAST_EXPENSES_TYPE_FORMULA.FORCAST_EXPENSES_TYPE_ID)
GO
sp_refreshview @viewname = 'V_GET_TAX_FORCAST_EXPENSES_TYPE_FORMULA_INFORMATION'
GO


/**
 * สร้าง View แสดงประวัติการปรับปรุงการประมาณการรายได้ภาษี 
 * ของแต่ละประเภทรายได้ภาษี
**/
IF OBJECT_ID('dbo.V_GET_TAX_FORCAST_INCOME_HISTORY_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_TAX_FORCAST_INCOME_HISTORY_INFORMATION;
GO
CREATE VIEW V_GET_TAX_FORCAST_INCOME_HISTORY_INFORMATION AS
	SELECT FORCAST_HIS.*
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL PERSON WHERE PERSON.PERSON_ID = FORCAST_HIS.USER_ID) AS CREATED_NAME
	FROM T_TAX_FORCAST_INCOME_HISTORY FORCAST_HIS
GO
sp_refreshview @viewname = 'V_GET_TAX_FORCAST_INCOME_HISTORY_INFORMATION'
GO


/**
 * View แสดงข้อมูลคำของบประมาณ (ไม่รวมส่วนของรายการ คชจ.)
 *
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_REQUEST_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_REQUEST_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_REQUEST_INFORMATION AS
	SELECT REQ.*
	, (SELECT AREA_NAME FROM T_AREA A WHERE A.AREA_ID = REQ.AREA_ID) AS AREA_NAME
	, (SELECT DEP_NAME FROM T_DEPARTMENT D WHERE D.DEP_ID = REQ.DEP_ID) AS DEP_NAME
	, (SELECT SORT_INDEX FROM T_DEPARTMENT D WHERE D.DEP_ID = REQ.DEP_ID) AS DEP_SORT_INDEX
	, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT S WHERE S.SUB_DEP_ID = REQ.SUB_DEP_ID) AS SUB_DEP_NAME
	
	-- ข้อมูลการ SignOff คำขอ
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = REQ.SIGNOFF_ID) as SIGNOFF_NAME
	-- ผู้บันทึกคำขอ
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = REQ.USER_ID) as CREATED_NAME
	-- ผู้ลบคำขอ
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = REQ.DELETED_ID) as DELETED_NAME
	-- ผู้จัดสรร
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = REQ.APPROVE_ID) as APPROVE_NAME


	-- ข้อมูลการจัดสรรงบประมาณ
	, ALLOCATE_HIS.NET_ALLOCATE_BUDGET_AMOUNT
	, ALLOCATE_HIS.NET_ALLOCATE_OFF_BUDGET_AMOUNT
	, ALLOCATE_HIS.NET_CASHBACK_BUDGET_AMOUNT
	, ALLOCATE_HIS.NET_CASHBACK_OFF_BUDGET_AMOUNT

	FROM (SELECT * FROM T_BUDGET_REQUEST_MASTER WHERE ACTIVE = 1) REQ
	LEFT JOIN (
		SELECT REQ_ID
		, SUM(CASE WHEN BUDGET_TYPE = 1 AND ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS NET_ALLOCATE_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 2 AND ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS NET_ALLOCATE_OFF_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 1 AND ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS NET_CASHBACK_BUDGET_AMOUNT
		, SUM(CASE WHEN BUDGET_TYPE = 2 AND ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS NET_CASHBACK_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_ALLOCATE_EXPENSES_HISTORY
		WHERE ACTIVE = 1
		GROUP BY REQ_ID
		) AS ALLOCATE_HIS
	ON (ALLOCATE_HIS.REQ_ID = REQ.REQ_ID)
GO
sp_refreshview @viewname = 'V_GET_BUDGET_REQUEST_INFORMATION'
GO


/**
 * View แสดงข้อมูลแต่ละรายการค่าใช้จ่ายของคำขอ งปม.
 * จะรวม จำนวนเงินที่ได้รับจัดสรร และ วันที่จัดสรร ผู้จัดสรร
 *
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_REQUEST_DETAIL_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_REQUEST_DETAIL_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_REQUEST_DETAIL_INFORMATION AS
	SELECT REQ_DT.*
	, (SELECT TEMPLATE_NAME FROM T_BUDGET_REQUEST_TEMPLATE TEMPLATE_MAS WHERE TEMPLATE_MAS.TEMPLATE_ID = REQ_DT.TEMPLATE_ID) AS TEMPLATE_NAME

	-- ชื่อค่าใช้จ่าย
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = REQ_DT.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = REQ_DT.PLAN_ID) AS PLAN_ORDER_SEQ

	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = REQ_DT.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = REQ_DT.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = REQ_DT.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = REQ_DT.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = REQ_DT.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = REQ_DT.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = REQ_DT.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = REQ_DT.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ

	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES WHERE EXPENSES.EXPENSES_ID = REQ_DT.EXPENSES_ID) AS EXPENSES_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM EXPENSES WHERE EXPENSES.EXPENSES_ID = REQ_DT.EXPENSES_ID) AS EXPENSES_ORDER_SEQ
	
	-- ข้อมูลการจัดสรรงปม. ตามคำขอ ของรายการค่าใช้จ่าย
	-- นำเลขที่คำขอและรายการค่าใช้จ่ายไปค้นหาใน Allocate history
	, ALLOCATE_HIS.ALLOCATE_BUDGET_AMOUNT -- จำนวนที่จัดสรรเพิ่ม
	, ALLOCATE_HIS.ALLOCATE_OFF_BUDGET_AMOUNT
	, ALLOCATE_HIS.CASHBACK_BUDGET_AMOUNT -- จำนวนที่ตัดงบคืนส่วนกลาง
	, ALLOCATE_HIS.CASHBACK_OFF_BUDGET_AMOUNT
	FROM (
		SELECT REQ_DT.*
		, REQ_MAS.BUDGET_TYPE
		, REQ_MAS.REFER_REQ_ID -- เลขที่หนังสืออ้างอิง (กรณีขอเพิ่มเติม)
		FROM T_BUDGET_REQUEST_DETAIL REQ_DT
		, T_BUDGET_REQUEST_MASTER REQ_MAS
		WHERE REQ_DT.ACTIVE = 1
		  AND REQ_MAS.REQ_ID = REQ_DT.REQ_ID
	) REQ_DT
	LEFT JOIN (
		SELECT REQ_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
		, SUM(CASE WHEN ADJUSTMENT_TYPE = 1 AND BUDGET_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS ALLOCATE_BUDGET_AMOUNT
		, SUM(CASE WHEN ADJUSTMENT_TYPE = 1 AND BUDGET_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS ALLOCATE_OFF_BUDGET_AMOUNT
		, SUM(CASE WHEN ADJUSTMENT_TYPE = 2 AND BUDGET_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS CASHBACK_BUDGET_AMOUNT
		, SUM(CASE WHEN ADJUSTMENT_TYPE = 2 AND BUDGET_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) AS CASHBACK_OFF_BUDGET_AMOUNT
		FROM T_BUDGET_ALLOCATE_EXPENSES_HISTORY
		WHERE ACTIVE = 1
		GROUP BY REQ_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
	) AS ALLOCATE_HIS
	ON (
		ALLOCATE_HIS.REQ_ID = REQ_DT.REQ_ID AND 
		ALLOCATE_HIS.PLAN_ID = REQ_DT.PLAN_ID AND
		ALLOCATE_HIS.PRODUCE_ID = REQ_DT.PRODUCE_ID AND
		ALLOCATE_HIS.ACTIVITY_ID = REQ_DT.ACTIVITY_ID AND
		ALLOCATE_HIS.BUDGET_TYPE_ID = REQ_DT.BUDGET_TYPE_ID AND
		ALLOCATE_HIS.EXPENSES_GROUP_ID = REQ_DT.EXPENSES_GROUP_ID AND
		ALLOCATE_HIS.EXPENSES_ID = REQ_DT.EXPENSES_ID
	)
GO
sp_refreshview @viewname = 'V_GET_BUDGET_REQUEST_DETAIL_INFORMATION'
GO




/**
 * View สรุปข้อมูลคำขอเงินงบประมาณของกรมสรรพสามิต
 * โดยใช้ข้อมูล รายการค่าใช้จ่ายตั้งต้น และไปค้นหาในคำขอเงินงบประมาณ
 * ดังนั้น ข้อมูลค่าใช้จ่ายจะออกมาทั้งหมด ในปีงบประมาณนั้นๆ
 *
**/
IF OBJECT_ID('dbo.V_GET_SUMMARY_BUDGET_REQUEST', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_SUMMARY_BUDGET_REQUEST;
GO
CREATE VIEW V_GET_SUMMARY_BUDGET_REQUEST AS
	SELECT BUDGET_EX.* 
	, BUDGET_REQ.AREA_ID, BUDGET_REQ.DEP_ID
	, BUDGET_REQ.REQ_TYPE, BUDGET_REQ.BUDGET_TYPE, BUDGET_REQ.SIGNOFF_FLAG
	, BUDGET_REQ.TOTAL_REQUEST_BUDGET
	FROM 
	(
		SELECT BUDGET_EX.*
		, PLN.PLAN_NAME, PLN.ORDER_SEQ AS PLAN_ORDER_SEQ
		, PRODUCE.PRODUCE_NAME, PRODUCE.ORDER_SEQ AS PRODUCE_ORDER_SEQ
		, ACTIVITY.ACTIVITY_NAME, ACTIVITY.ORDER_SEQ AS ACTIVITY_ORDER_SEQ
		, BUDGET_TYPE.BUDGET_TYPE_NAME, BUDGET_TYPE.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ
		, EXPENSES_GRP.EXPENSES_MASTER_ID, EXPENSES_GRP.EXPENSES_MASTER_NAME, EXPENSES_GRP.EXPENSES_GROUP_NAME, EXPENSES_GRP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
		, EXPENSES.EXPENSES_NAME, EXPENSES.ORDER_SEQ AS EXPENSES_ORDER_SEQ
		FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) BUDGET_EX
		JOIN T_PLAN_CONFIGURE PLN
			ON(PLN.PLAN_ID = BUDGET_EX.PLAN_ID)
		JOIN T_PRODUCE_CONFIGURE PRODUCE
			ON(PRODUCE.PRODUCE_ID = BUDGET_EX.PRODUCE_ID)
		JOIN T_ACTIVITY_CONFIGURE ACTIVITY
			ON(ACTIVITY.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID)
		JOIN T_BUDGET_TYPE BUDGET_TYPE
			ON(BUDGET_TYPE.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID)
		JOIN (
			SELECT EXPENSES_GRP.*, EXPENSES_MAS.EXPENSES_MASTER_NAME
			FROM T_EXPENSES_GROUP EXPENSES_GRP, T_EXPENSES_MASTER EXPENSES_MAS
			WHERE EXPENSES_GRP.EXPENSES_MASTER_ID = EXPENSES_MAS.EXPENSES_MASTER_ID
		) EXPENSES_GRP
			ON(EXPENSES_GRP.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID)
		JOIN T_EXPENSES_ITEM EXPENSES
			ON(EXPENSES.EXPENSES_ID = BUDGET_EX.EXPENSES_ID)
	) AS BUDGET_EX
	LEFT JOIN (
		SELECT REQ_MAS.REQ_TYPE, REQ_MAS.BUDGET_TYPE, REQ_MAS.YR AS REQ_YR
		, REQ_MAS.DEP_ID, REQ_MAS.AREA_ID, REQ_MAS.SIGNOFF_FLAG
		, REQ_DETAIL.PLAN_ID, REQ_DETAIL.PRODUCE_ID, REQ_DETAIL.ACTIVITY_ID
		, REQ_DETAIL.BUDGET_TYPE_ID, REQ_DETAIL.EXPENSES_GROUP_ID, REQ_DETAIL.EXPENSES_ID
		, REQ_DETAIL.TOTAL_REQUEST_BUDGET
		FROM T_BUDGET_REQUEST_MASTER REQ_MAS, T_BUDGET_REQUEST_DETAIL REQ_DETAIL
		WHERE REQ_MAS.REQ_ID = REQ_DETAIL.REQ_ID
		  AND REQ_MAS.ACTIVE = 1
	) AS BUDGET_REQ
		ON(
			BUDGET_REQ.REQ_YR = BUDGET_EX.YR AND
			BUDGET_REQ.PLAN_ID = BUDGET_EX.PLAN_ID AND 
			BUDGET_REQ.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			BUDGET_REQ.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			BUDGET_REQ.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			BUDGET_REQ.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			BUDGET_REQ.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
		);
GO
sp_refreshview @viewname = 'V_GET_SUMMARY_BUDGET_REQUEST'
GO


/**
 * View สรุปข้อมูลการจัดสรรเงิน ลงให้กับหน่วยงาน
 * ทั้งที่เป็นจัดสรร ตามหมวดค่าใช้จ่าย และ จัดสรรตามโครงการหรือค่าใช้จ่าย
 * โดยใช้ข้อมูล ค่าใช้จ่าย หรือ โครงการของกรมสรรพสามิตในปีงบประมาณนั้นๆ ตั้งต้น
 * แล้วนำไป Left join กับรายการจัดสรรให้กับหน่วยงานภูมิภาค
 * ดังนั้น จะได้ข้อมูล โครงการ ค่าใช้จ่าย ออกมาทั้งหมดในปีนั้น
 *
**/
IF OBJECT_ID('dbo.V_GET_SUMMARY_BUDGET_ALLOCATE', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_SUMMARY_BUDGET_ALLOCATE;
GO
CREATE VIEW V_GET_SUMMARY_BUDGET_ALLOCATE AS
	SELECT BUDGET_EX.*
	, EXPEN_ALLOCATE.AREA_ID
	, EXPEN_ALLOCATE.DEP_ID, EXPEN_ALLOCATE.DEP_NAME
	, EXPEN_ALLOCATE.ALLOCATE_EXPENSES_GROUP_ID

	, EXPEN_ALLOCATE.ALLOCATE_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.DEP_USE_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.DEP_REMAIN_BUDGET_AMOUNT
	
	, EXPEN_ALLOCATE.ALLOCATE_OFF_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.DEP_USE_OFF_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.DEP_REMAIN_OFF_BUDGET_AMOUNT

	, EXPEN_ALLOCATE.ALLOCATE_GRP_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.GRP_USE_BUDGET_AMOUNT, EXPEN_ALLOCATE.GRP_REMAIN_BUDGET_AMOUNT

	, EXPEN_ALLOCATE.ALLOCATE_GRP_OFF_BUDGET_AMOUNT
	, EXPEN_ALLOCATE.GRP_USE_OFF_BUDGET_AMOUNT, EXPEN_ALLOCATE.GRP_REMAIN_OFF_BUDGET_AMOUNT
	FROM 
	(
		SELECT BUDGET_EX.*, EXPEN_PRO.PROJECT_FOR_TYPE, EXPEN_PRO.PROJECT_ID, EXPEN_PRO.PROJECT_NAME 
		FROM (
			SELECT BUDGET_EX.*
			, PLN.PLAN_NAME, PLN.ORDER_SEQ AS PLAN_ORDER_SEQ
			, PRODUCE.PRODUCE_NAME, PRODUCE.ORDER_SEQ AS PRODUCE_ORDER_SEQ
			, ACTIVITY.ACTIVITY_NAME, ACTIVITY.ORDER_SEQ AS ACTIVITY_ORDER_SEQ
			, BUDGET_TYPE.BUDGET_TYPE_NAME, BUDGET_TYPE.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ
			, EXPENSES_GRP.EXPENSES_MASTER_ID, EXPENSES_GRP.EXPENSES_MASTER_NAME, EXPENSES_GRP.EXPENSES_GROUP_NAME, EXPENSES_GRP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
			, EXPENSES_GRP.ALLOCATE_GROUP_FLAG AS EXPENSES_GROUP_ALLOCATE_GROUP_FLAG
			, EXPENSES.EXPENSES_NAME, EXPENSES.ORDER_SEQ AS EXPENSES_ORDER_SEQ
			FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) BUDGET_EX
			JOIN T_PLAN_CONFIGURE PLN
				ON(PLN.PLAN_ID = BUDGET_EX.PLAN_ID)
			JOIN T_PRODUCE_CONFIGURE PRODUCE
				ON(PRODUCE.PRODUCE_ID = BUDGET_EX.PRODUCE_ID)
			JOIN T_ACTIVITY_CONFIGURE ACTIVITY
				ON(ACTIVITY.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID)
			JOIN T_BUDGET_TYPE BUDGET_TYPE
				ON(BUDGET_TYPE.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID)
			JOIN (
				SELECT EXPENSES_GRP.*, EXPENSES_MAS.EXPENSES_MASTER_NAME
				FROM T_EXPENSES_GROUP EXPENSES_GRP, T_EXPENSES_MASTER EXPENSES_MAS
				WHERE EXPENSES_GRP.EXPENSES_MASTER_ID = EXPENSES_MAS.EXPENSES_MASTER_ID
			) EXPENSES_GRP
				ON(EXPENSES_GRP.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID)
			JOIN T_EXPENSES_ITEM EXPENSES
				ON(EXPENSES.EXPENSES_ID = BUDGET_EX.EXPENSES_ID)
		) AS BUDGET_EX
		-- ค้นหาโครงการ
		LEFT JOIN T_BUDGET_EXPENSES_PROJECT EXPEN_PRO
			ON(
				EXPEN_PRO.YR = BUDGET_EX.YR AND
				EXPEN_PRO.PLAN_ID = BUDGET_EX.PLAN_ID AND
				EXPEN_PRO.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
				EXPEN_PRO.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
				EXPEN_PRO.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
				EXPEN_PRO.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
				EXPEN_PRO.EXPENSES_ID = BUDGET_EX.EXPENSES_ID AND
				EXPEN_PRO.ACTIVE = 1
			)
	) AS BUDGET_EX
	-- จัดสรร ตามโครงการ/ค่าใช้จ่าย หรือ ตามหมวดค่าใช้จ่าย
	LEFT JOIN (
		SELECT A.*
		, ALLOCATE_GRP.ALLOCATE_BUDGET_AMOUNT AS ALLOCATE_GRP_BUDGET_AMOUNT
		, ALLOCATE_GRP.USE_BUDGET_AMOUNT AS GRP_USE_BUDGET_AMOUNT
		, ALLOCATE_GRP.REMAIN_BUDGET_AMOUNT AS GRP_REMAIN_BUDGET_AMOUNT

		, ALLOCATE_GRP.ALLOCATE_OFF_BUDGET_AMOUNT AS ALLOCATE_GRP_OFF_BUDGET_AMOUNT
		, ALLOCATE_GRP.USE_OFF_BUDGET_AMOUNT AS GRP_USE_OFF_BUDGET_AMOUNT
		, ALLOCATE_GRP.REMAIN_OFF_BUDGET_AMOUNT AS GRP_REMAIN_OFF_BUDGET_AMOUNT
		FROM(
			SELECT EXPEN_ALLOCATE.YR AS ALLOCATE_YR, EXPEN_ALLOCATE.AREA_ID
			, EXPEN_ALLOCATE.ALLOCATE_EXPENSES_GROUP_ID
			, EXPEN_ALLOCATE.DEP_ID, DEP.DEP_NAME
			, PLAN_ID, PRODUCE_ID, ACTIVITY_ID
			, BUDGET_TYPE_ID, EXPENSES_GROUP_ID
			, EXPENSES_ID, PROJECT_ID
			, ALLOCATE_BUDGET_AMOUNT
			, USE_BUDGET_AMOUNT AS DEP_USE_BUDGET_AMOUNT
			, REMAIN_BUDGET_AMOUNT AS DEP_REMAIN_BUDGET_AMOUNT
			, ALLOCATE_OFF_BUDGET_AMOUNT
			, USE_OFF_BUDGET_AMOUNT AS DEP_USE_OFF_BUDGET_AMOUNT
			, REMAIN_OFF_BUDGET_AMOUNT AS DEP_REMAIN_OFF_BUDGET_AMOUNT

			FROM T_BUDGET_ALLOCATE_EXPENSES EXPEN_ALLOCATE, T_DEPARTMENT DEP
			WHERE EXPEN_ALLOCATE.ACTIVE = 1 AND EXPEN_ALLOCATE.DEP_ID = DEP.DEP_ID
		) AS A
		-- จัดสรร ตามหมวดค่าใช้จ่าย
		LEFT JOIN T_BUDGET_ALLOCATE_EXPENSES_GROUP ALLOCATE_GRP
			ON(ALLOCATE_GRP.ALLOCATE_EXPENSES_GROUP_ID = A.ALLOCATE_EXPENSES_GROUP_ID)
	) AS EXPEN_ALLOCATE
		ON(
			EXPEN_ALLOCATE.ALLOCATE_YR = BUDGET_EX.YR AND
			EXPEN_ALLOCATE.PLAN_ID = BUDGET_EX.PLAN_ID AND 
			EXPEN_ALLOCATE.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			EXPEN_ALLOCATE.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			EXPEN_ALLOCATE.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			EXPEN_ALLOCATE.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			EXPEN_ALLOCATE.EXPENSES_ID = BUDGET_EX.EXPENSES_ID AND
			(
				(EXPEN_ALLOCATE.PROJECT_ID = BUDGET_EX.PROJECT_ID)
				-- ไม่สามารถใช้ null equal null ได้
				OR (EXPEN_ALLOCATE.PROJECT_ID IS NULL AND BUDGET_EX.PROJECT_ID IS NULL)
				-- ส่วนกลางเพิ่มโครงการภายหลังจากมีการจัดสรรงบ ให้กับหน่วยงานแล้ว
				OR (EXPEN_ALLOCATE.PROJECT_ID IS NULL AND BUDGET_EX.PROJECT_ID IS NOT NULL)
			)
		);
GO
sp_refreshview @viewname = 'V_GET_SUMMARY_BUDGET_ALLOCATE'
GO



/**
 * View แสดงข้อมูลรายการค่าใช้จ่าย ตามคำขอเงินงบประมาณ กับ ยอดจัดสรรสะสม ยอดใช้ไป ยอดคงเหลือ
 *
**/
IF OBJECT_ID('dbo.V_GET_DEPARTMENT_REQUEST_EXPENSES_BUDGET_AND_ALLOCATE_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_DEPARTMENT_REQUEST_EXPENSES_BUDGET_AND_ALLOCATE_INFORMATION;
GO
CREATE VIEW V_GET_DEPARTMENT_REQUEST_EXPENSES_BUDGET_AND_ALLOCATE_INFORMATION AS
	SELECT REQ.*
	-- ข้อมูลงบประมาณคงคลัง ของแต่ละรายการค่าใช้จ่ายฃ
	--, BUDGET_EXPENSES.BUDGET_FLAG, BUDGET_EXPENSES.TEMPORARY_YR
	, (SELECT BUDGET_FLAG FROM T_BUDGET_MASTER BUDGET_MAS WHERE BUDGET_MAS.YR = REQ.YR) AS BUDGET_FLAG
	, (SELECT TEMPORARY_YR FROM T_BUDGET_MASTER BUDGET_MAS WHERE BUDGET_MAS.YR = REQ.YR) AS TEMPORARY_YR
	, CASE WHEN BUDGET_EXPENSES.RELEASE_BUDGET = 1 THEN ISNULL(BUDGET_EXPENSES.REMAIN_BUDGET_AMOUNT, 0) ELSE CAST(0 AS DECIMAL(20,2)) END AS BALANCE_BUDGET_AMOUNT -- เงินงบประมาณคงเหลือสุทธิ
	, CASE WHEN BUDGET_EXPENSES.RELEASE_OFF_BUDGET = 1 THEN ISNULL(BUDGET_EXPENSES.REMAIN_OFF_BUDGET_AMOUNT, 0) ELSE CAST(0 AS DECIMAL(20,2)) END AS BALANCE_OFF_BUDGET_AMOUNT -- เงินนอก งปม. คงเหลือสุทธิ
	, BUDGET_EXPENSES.CAN_ADD_PROJECT -- รายการค่าใช้จ่ายนี้ สามารถเพิ่มโครงการได้ใช่หรือไม่?

	-- ข้อมูลงบประมาณของแต่ละรายการค่าใช้จ่าย ของหน่วยงาน
	, ISNULL(ALLOCATE_EXPENSES.ALLOCATE_BUDGET_AMOUNT, 0) AS DEP_ALLOCATE_BUDGET_AMOUNT -- ยอดจัดสรรด้วยเงินงบประมาณ
	, ISNULL(ALLOCATE_EXPENSES.ALLOCATE_OFF_BUDGET_AMOUNT, 0) AS DEP_ALLOCATE_OFF_BUDGET_AMOUNT -- ยอดจัดสรรด้วยเงินนอก งปม.
	, ISNULL(ALLOCATE_EXPENSES.NET_BUDGET_AMOUNT, 0) AS DEP_NET_BUDGET_AMOUNT -- เงิน งปม. + เงินนอก งปม.
	, ISNULL(ALLOCATE_EXPENSES.USE_BUDGET_AMOUNT, 0) AS DEP_USE_BUDGET_AMOUNT -- ยอดใช้จ่ายสะสม
	, ISNULL(ALLOCATE_EXPENSES.REMAIN_BUDGET_AMOUNT, 0) AS DEP_REMAIN_BUDGET_AMOUNT -- ยอดคงเหลือ
	FROM (
		SELECT REQ_MAS.REQ_ID, REQ_MAS.YR, REQ_MAS.AREA_ID, REQ_MAS.AREA_NAME, REQ_MAS.DEP_ID, REQ_MAS.DEP_NAME
		-- ข้อมูลคำขอ
		, REQ_MAS.REQ_COUNT -- คำขอเพิ่มเติม ส่งไปขอครั้งที่
		, REQ_MAS.BUDGET_TYPE -- 1 = เงิน งปม., 2 = เงินนอก งปม.
		, REQ_MAS.REQ_TYPE -- 1 = คำขอต้นปี, 2 = คำขอเพิ่มเติม
		, REQ_MAS.TOTAL_REQUEST_BUDGET AS NET_REQUEST_BUDGET_AMOUNT
		, REQ_MAS.PROCESS_STATUS, REQ_MAS.REMARK_TEXT
		, REQ_MAS.SIGNOFF_FLAG -- 1 = SignOff, 0 = รอ SignOff (เฉพาะคำขอต้นปี)

		-- ข้อมูลหมวด
		, REQ_DETAIL.PLAN_ID, REQ_DETAIL.PLAN_NAME
		, REQ_DETAIL.PRODUCE_ID, REQ_DETAIL.PRODUCE_NAME
		, REQ_DETAIL.ACTIVITY_ID, REQ_DETAIL.ACTIVITY_NAME
		, REQ_DETAIL.BUDGET_TYPE_ID, REQ_DETAIL.BUDGET_TYPE_NAME
		, dbo.fn_GetBudgetTypeGovenmentReferCode(REQ_DETAIL.BUDGET_TYPE_ID, NULL) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
		-- 1 = ค่าใช้จ่ายภายใต้ งบรายจ่ายนี้ สามารถใช้จ่ายแบบถัวเฉลี่ยได้
		, dbo.fn_GetBudgetTypeShareBudget(REQ_DETAIL.BUDGET_TYPE_ID) AS BUDGET_TYPE_SHARED_BUDGET
		, REQ_DETAIL.EXPENSES_GROUP_ID, REQ_DETAIL.EXPENSES_GROUP_NAME
		, dbo.fn_GetExpensesGroupGovenmentReferCode(REQ_DETAIL.EXPENSES_GROUP_ID, NULL) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE

		-- รายการค่าใช้จ่ายที่ส่งคำขอ
		, REQ_DETAIL.EXPENSES_ID, REQ_DETAIL.EXPENSES_NAME
		, REQ_DETAIL.TOTAL_REQUEST_BUDGET AS REQUEST_BUDGET_AMOUNT

		FROM V_GET_BUDGET_REQUEST_INFORMATION REQ_MAS
		, V_GET_BUDGET_REQUEST_DETAIL_INFORMATION REQ_DETAIL
		WHERE REQ_MAS.REQ_ID = REQ_DETAIL.REQ_ID
	) AS REQ
	-- ข้อมูลงบประมาณที่จัดสรรลงไปให้กับหน่วยงาน
	LEFT JOIN (
		SELECT DEP_ID, YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID
		, EXPENSES_GROUP_ID, EXPENSES_ID
		, SUM(ALLOCATE_BUDGET_AMOUNT) AS ALLOCATE_BUDGET_AMOUNT
		, SUM(ALLOCATE_OFF_BUDGET_AMOUNT) AS ALLOCATE_OFF_BUDGET_AMOUNT
		, SUM(NET_BUDGET_AMOUNT) AS NET_BUDGET_AMOUNT
		, SUM(USE_BUDGET_AMOUNT) AS USE_BUDGET_AMOUNT
		, SUM(REMAIN_BUDGET_AMOUNT) AS REMAIN_BUDGET_AMOUNT
		FROM T_BUDGET_ALLOCATE_EXPENSES
		WHERE ACTIVE = 1
		GROUP BY DEP_ID, YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
	) ALLOCATE_EXPENSES
	ON (REQ.DEP_ID = ALLOCATE_EXPENSES.DEP_ID AND 
		REQ.YR = ALLOCATE_EXPENSES.YR AND
		REQ.PLAN_ID = ALLOCATE_EXPENSES.PLAN_ID AND
		REQ.PRODUCE_ID = ALLOCATE_EXPENSES.PRODUCE_ID AND
		REQ.ACTIVITY_ID = ALLOCATE_EXPENSES.ACTIVITY_ID AND
		REQ.BUDGET_TYPE_ID = ALLOCATE_EXPENSES.BUDGET_TYPE_ID AND
		REQ.EXPENSES_GROUP_ID = ALLOCATE_EXPENSES.EXPENSES_GROUP_ID AND
		REQ.EXPENSES_ID = ALLOCATE_EXPENSES.EXPENSES_ID
		)
	-- ข้อมูลงบประมาณคงคลัง ของแต่ละรายการค่าใช้จ่าย
	-- และ ปีงบประมาณนั้นจะต้องเปิดการใช้งาน งบประมาณแล้ว
	LEFT JOIN (
		SELECT D.*, M.TEMPORARY_YR, M.BUDGET_FLAG -- 1 ปกติ, 2 พลางก่อน
			, M.RELEASE_BUDGET, M.RELEASE_OFF_BUDGET
		FROM T_BUDGET_EXPENSES D, T_BUDGET_MASTER M 
		WHERE D.BUDGET_ID = M.BUDGET_ID 
		  -- AND M.RELEASE_BUDGET = 1 
		  -- AND M.RELEASE_OFF_BUDGET = 1
		  AND D.ACTIVE = 1 -- เฉพาะรายการ คชจ. ที่ใช้งาน
		) as BUDGET_EXPENSES
	ON (REQ.YR = BUDGET_EXPENSES.YR AND
		REQ.PLAN_ID = BUDGET_EXPENSES.PLAN_ID AND
		REQ.PRODUCE_ID = BUDGET_EXPENSES.PRODUCE_ID AND
		REQ.ACTIVITY_ID = BUDGET_EXPENSES.ACTIVITY_ID AND
		REQ.BUDGET_TYPE_ID = BUDGET_EXPENSES.BUDGET_TYPE_ID AND
		REQ.EXPENSES_GROUP_ID = BUDGET_EXPENSES.EXPENSES_GROUP_ID AND
		REQ.EXPENSES_ID = BUDGET_EXPENSES.EXPENSES_ID)
GO
sp_refreshview @viewname = 'V_GET_DEPARTMENT_REQUEST_EXPENSES_BUDGET_AND_ALLOCATE_INFORMATION'
GO



/**
 * View ข้อมูลภาพรวมงบประมาณทั้งหมดของหน่วยงาน เช่น
 * ยอดจัดสรร (จัดสรรเป็นก้อน และ จัดสรรตามรายการค่าใช้จ่าย) รายงานผล
**/
IF OBJECT_ID('dbo.V_GET_DEPARTMENT_EXPENSES_BUDGET_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_DEPARTMENT_EXPENSES_BUDGET_INFORMATION;
GO
CREATE VIEW V_GET_DEPARTMENT_EXPENSES_BUDGET_INFORMATION AS
	SELECT ALLOCATE_EX.*
	, ISNULL(ALLOCATE_EXPENSES_GROUP.ALLOCATE_BUDGET_AMOUNT, 0) AS EX_GRP_ALLOCATE_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.USE_BUDGET_AMOUNT, 0) AS EX_GRP_USE_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.REMAIN_BUDGET_AMOUNT, 0) AS EX_GRP_REMAIN_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.ALLOCATE_OFF_BUDGET_AMOUNT, 0) AS EX_GRP_ALLOCATE_OFF_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.USE_OFF_BUDGET_AMOUNT, 0) AS EX_GRP_USE_OFF_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.REMAIN_OFF_BUDGET_AMOUNT, 0) AS EX_GRP_REMAIN_OFF_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.NET_BUDGET_AMOUNT, 0) AS EX_GRP_NET_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.NET_USE_BUDGET_AMOUNT, 0) AS EX_GRP_NET_USE_BUDGET_AMOUNT
	, ISNULL(ALLOCATE_EXPENSES_GROUP.NET_REMAIN_BUDGET_AMOUNT, 0) AS EX_GRP_NET_REMAIN_BUDGET_AMOUNT
	FROM(
		SELECT BUDGET_ALLOCATE_MAS.ALLOCATE_BUDGET_AMOUNT AS DEP_ALLOCATE_BUDGET_AMOUNT -- เงิน งปม. สุทธิที่ได้รับจัดสรร
		, BUDGET_ALLOCATE_MAS.USE_BUDGET_AMOUNT AS DEP_USE_BUDGET_AMOUNT -- ใช้จ่ายเงินงบประมาณ สะสม
		, BUDGET_ALLOCATE_MAS.REMAIN_BUDGET_AMOUNT AS DEP_REMAIN_BUDGET_AMOUNT -- เงินงบประมาณ คงเหลือสุทธิ
		
		, BUDGET_ALLOCATE_MAS.ALLOCATE_OFF_BUDGET_AMOUNT AS DEP_ALLOCATE_OFF_BUDGET_AMOUNT -- เงินนอก งปม. สุทธิที่ได้รับจัดสรร
		, BUDGET_ALLOCATE_MAS.USE_OFF_BUDGET_AMOUNT AS DEP_USE_OFF_BUDGET_AMOUNT -- ใช้จ่ายเงินนอกงบประมาณ สะสม
		, BUDGET_ALLOCATE_MAS.REMAIN_OFF_BUDGET_AMOUNT AS DEP_REMAIN_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณ คงเหลือสุทธิ

		, BUDGET_ALLOCATE_MAS.NET_BUDGET_AMOUNT AS DEP_NET_BUDGET_AMOUNT -- งปม. สุทธิของหน่วยงาน
		, BUDGET_ALLOCATE_MAS.NET_USE_BUDGET_AMOUNT AS DEP_NET_USE_BUDGET_AMOUNT -- งปม. สุทธิที่หน่วยงานใช้ไป
		, BUDGET_ALLOCATE_MAS.NET_REMAIN_BUDGET_AMOUNT AS DEP_NET_REMAIN_BUDGET_AMOUNT -- งปม. คงเหลือของหน่วยงาน

		, BUDGET_ALLOCATE_MAS.LATEST_ALLOCATE_DATETIME AS DEP_LATEST_ALLOCATE_DATETIME

		, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = BUDGET_ALLOCATE_MAS.LATEST_ALLOCATE_ID) as DEP_LATEST_ALLOCATE_NAME
		, BUDGET_ALLOCATE_MAS.LATEST_REPORT_DATETIME
		, BUDGET_ALLOCATE_MAS.LATEST_REPORT_ID
		, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = BUDGET_ALLOCATE_MAS.LATEST_REPORT_ID) as LATEST_REPORT_NAME
	
		-- รายการค่าใช้จ่าย
		, ALLOCATE_EXPENSES.*
		, (SELECT DEP_NAME FROM T_DEPARTMENT D WHERE D.DEP_ID = ALLOCATE_EXPENSES.DEP_ID) AS DEP_NAME
		, (SELECT SORT_INDEX FROM T_DEPARTMENT D WHERE D.DEP_ID = ALLOCATE_EXPENSES.DEP_ID) AS DEP_SORT_INDEX
		, (SELECT DEP_CODE FROM T_DEPARTMENT D WHERE D.DEP_ID = ALLOCATE_EXPENSES.DEP_ID) AS DEP_CODE
		, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT S WHERE S.SUB_DEP_ID = ALLOCATE_EXPENSES.SUB_DEP_ID) AS SUB_DEP_NAME
		
		, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = ALLOCATE_EXPENSES.PLAN_ID) AS PLAN_NAME
		, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = ALLOCATE_EXPENSES.PLAN_ID) AS PLAN_ORDER_SEQ

		, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = ALLOCATE_EXPENSES.PRODUCE_ID) AS PRODUCE_NAME
		, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = ALLOCATE_EXPENSES.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

		, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = ALLOCATE_EXPENSES.ACTIVITY_ID) AS ACTIVITY_NAME
		, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = ALLOCATE_EXPENSES.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

		, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = ALLOCATE_EXPENSES.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
		, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = ALLOCATE_EXPENSES.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

		, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = ALLOCATE_EXPENSES.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = ALLOCATE_EXPENSES.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ

		, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES_ITEM WHERE EXPENSES_ITEM.EXPENSES_ID = ALLOCATE_EXPENSES.EXPENSES_ID) AS EXPENSES_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM EXPENSES_ITEM WHERE EXPENSES_ITEM.EXPENSES_ID = ALLOCATE_EXPENSES.EXPENSES_ID) AS EXPENSES_ORDER_SEQ

		, (SELECT PROJECT_EX.PROJECT_NAME FROM T_BUDGET_EXPENSES_PROJECT PROJECT_EX WHERE PROJECT_EX.PROJECT_ID = ALLOCATE_EXPENSES.PROJECT_ID) AS PROJECT_NAME

		FROM T_BUDGET_ALLOCATE BUDGET_ALLOCATE_MAS
		, T_BUDGET_ALLOCATE_EXPENSES ALLOCATE_EXPENSES
		WHERE ALLOCATE_EXPENSES.ACTIVE = 1
		  AND BUDGET_ALLOCATE_MAS.ALLOCATE_ID = ALLOCATE_EXPENSES.ALLOCATE_ID
	) AS ALLOCATE_EX

	-- การจัดสรรงบประมาณเป็นก้อน ตามหมวดค่าใช้จ่าย
	LEFT JOIN (SELECT * FROM T_BUDGET_ALLOCATE_EXPENSES_GROUP WHERE ACTIVE = 1) AS ALLOCATE_EXPENSES_GROUP
		ON(
			ALLOCATE_EXPENSES_GROUP.ALLOCATE_ID = ALLOCATE_EX.ALLOCATE_ID AND
			ALLOCATE_EXPENSES_GROUP.PLAN_ID = ALLOCATE_EX.PLAN_ID AND
			ALLOCATE_EXPENSES_GROUP.PRODUCE_ID = ALLOCATE_EX.PRODUCE_ID AND
			ALLOCATE_EXPENSES_GROUP.ACTIVITY_ID = ALLOCATE_EX.ACTIVITY_ID AND
			ALLOCATE_EXPENSES_GROUP.BUDGET_TYPE_ID = ALLOCATE_EX.BUDGET_TYPE_ID AND
			ALLOCATE_EXPENSES_GROUP.EXPENSES_GROUP_ID = ALLOCATE_EX.EXPENSES_GROUP_ID
		)
GO
sp_refreshview @viewname = 'V_GET_DEPARTMENT_EXPENSES_BUDGET_INFORMATION'
GO


/**
 * View แสดงประวัติการรายงานผล การใช้จ่ายงบประมาณของหน่วยงาน
 *
**/
IF OBJECT_ID('dbo.V_GET_DEPARTMENT_REPORT_EXPENSES_HISTORY', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_DEPARTMENT_REPORT_EXPENSES_HISTORY;
GO
CREATE VIEW V_GET_DEPARTMENT_REPORT_EXPENSES_HISTORY AS
	SELECT REPORTED_EXPENSES_HISTORY.*
	, (SELECT DEP_NAME FROM T_DEPARTMENT D WHERE D.DEP_ID = REPORTED_EXPENSES_HISTORY.DEP_ID) AS DEP_NAME
	, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT S WHERE S.SUB_DEP_ID = REPORTED_EXPENSES_HISTORY.SUB_DEP_ID) AS SUB_DEP_NAME
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = REPORTED_EXPENSES_HISTORY.PLAN_ID) AS PLAN_NAME
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = REPORTED_EXPENSES_HISTORY.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = REPORTED_EXPENSES_HISTORY.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = REPORTED_EXPENSES_HISTORY.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = REPORTED_EXPENSES_HISTORY.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES_ITEM WHERE EXPENSES_ITEM.EXPENSES_ID = REPORTED_EXPENSES_HISTORY.EXPENSES_ID) AS EXPENSES_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = REPORTED_EXPENSES_HISTORY.REPORTED_ID) as REPORTED_NAME

	FROM T_BUDGET_REPORTED_USE_EXPENSES_HISTORY REPORTED_EXPENSES_HISTORY
	WHERE REPORTED_EXPENSES_HISTORY.ACTIVE = 1
GO
sp_refreshview @viewname = 'V_GET_DEPARTMENT_REPORT_EXPENSES_HISTORY'
GO



/**
 * View แสดงข้อมูลกระแสเงินงบประมาณของหน่วยงาน
 * ได้แก่ ประวัติการจัดสรร ประวัติการเบิกจ่าย ยอดคงเหลือสุทธิ และ อื่นๆ
 *
 * หากกรมสรรพสามิต ยังไม่จัดสรรงบประมาณลงสู่หน่วยงานภูมิภาค View นี้จะไม่มีข้อมูล
 * เนื่องจากไม่ได้ใช้ข้อมูลจากรายการค่าใช้จ่ายที่กรมสรรพสามิตมีมาตั้งต้น
 *
**/
IF OBJECT_ID('dbo.V_GET_DEPARTMENT_BUDGET_CASH_FLOW_STATEMENT', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_DEPARTMENT_BUDGET_CASH_FLOW_STATEMENT;
GO
CREATE VIEW V_GET_DEPARTMENT_BUDGET_CASH_FLOW_STATEMENT AS
	SELECT BUDGET_EX.*

	-- ข้อมูลการ บันทึกผลการใช้จ่ายงบประมาณของหน่วยงานภูมิภาค แต่ละรายการค่าใช้จ่าย
	, BUDGET_EX_REPORT.MN AS REPORT_MN
	, BUDGET_EX_REPORT.REPORT_CODE -- เลขที่ขอเบิกจ่าย GFMIS
	, BUDGET_EX_REPORT.REPORT_BUDGET_AMOUNT 
	, BUDGET_EX_REPORT.BUDGET_TYPE AS REPORT_BUDGET_TYPE -- ประเภทงบประมาณ ที่รายงานผล (1 = เงินงบ, 2 = เงินนอกงบ)
	, BUDGET_EX_REPORT.REPORTED_DATETIME
	, CAST(BUDGET_EX_REPORT.REPORTED_DATETIME AS DATE) AS REPORTED_DATE
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL X WHERE X.PERSON_ID = BUDGET_EX_REPORT.REPORTED_ID) AS REPORTED_NAME
	FROM(
		SELECT BUDGET_EX.*
	
		, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_NAME
		, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_ORDER_SEQ

		, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_NAME
		, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

		, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_NAME
		, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

		, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
		, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

		, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ

		, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM EXPENSES_ITEM WHERE EXPENSES_ITEM.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM EXPENSES_ITEM WHERE EXPENSES_ITEM.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_ORDER_SEQ

		, (SELECT PROJECT_EX.PROJECT_NAME FROM T_BUDGET_EXPENSES_PROJECT PROJECT_EX WHERE PROJECT_EX.PROJECT_ID = BUDGET_EX.PROJECT_ID) AS PROJECT_NAME

		-- ไม่ใช้เขตพื้นที่จากข้อมูลหน่วยงาน (เผื่อกรณีที่หน่วยงาน เปลี่ยนเขตพื้นที่ จะทำให้ได้ข้อมูลที่ไม่ถูกต้อง ณ ช่วงเวลานั้น)
		, (SELECT AREA_NAME FROM T_AREA X WHERE X.AREA_ID = BUDGET_EX.AREA_ID) AS AREA_NAME 
		-- ข้อมูลหน่วยงาน
		, DEPARTMENT_INFO.DEP_NAME
		, DEP_SORT_INDEX = DEPARTMENT_INFO.SORT_INDEX

		-- ประวัติการจัดสรรงบประมาณลงสู่หน่วยงานภูมิภาค
		, HIS_REFER_DOC_NO = BUDGET_EX_HIS.REFER_DOC_NO -- เลขที่อ้างอิงการจัดสรรงบประมาณ
		, HIS_ALLOCATE_PERIOD = BUDGET_EX_HIS.PERIOD_CODE -- ครั้งที่จัดสรร ที่ผู้ใช้งานระบบ (ง241/001, งน001) เป็นต้น
		, HIS_BUDGET_TYPE = BUDGET_EX_HIS.BUDGET_TYPE
		-- EXPEN = ยอดจัดสรรเป็นรายการค่าใช้จ่าย
		-- GROU = ยอดจัดสรรเป็นกลุ่ม (แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย)
		, HIS_ALLOCATE_SOURCE_TYPE = BUDGET_EX_HIS.ALLOCATE_SOURCE_TYPE
		, HIS_ALLOCATE_BUDGET_AMOUNT = BUDGET_EX_HIS.ALLOCATE_BUDGET_AMOUNT
		, HIS_ALLOCATE_DATE = BUDGET_EX_HIS.ALLOCATE_DATE
		FROM (SELECT * FROM T_BUDGET_ALLOCATE_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX
		JOIN V_GET_DEPARTMENT_INFORMATION  DEPARTMENT_INFO
			ON (DEPARTMENT_INFO.DEP_ID = BUDGET_EX.DEP_ID)
		-- ประวัติการจัดสรรงบประมาณให้หน่วยงานภูมิภาค (นำมาเฉพาะ จัดสรรเพิ่ม AdjustmentType = 1)
		JOIN (
			
			-- จัดสรรงบประมาณ แต่ละรายการ คชจ.
			SELECT 'EXPEN' as ALLOCATE_SOURCE_TYPE,YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
				, REFER_DOC_NO, PERIOD_CODE, ALLOCATE_DATE, BUDGET_TYPE
				, ALLOCATE_BUDGET_AMOUNT = SUM(CASE WHEN ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) - SUM(CASE WHEN ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END)
			FROM(
				SELECT YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
				, REFER_DOC_NO, PERIOD_CODE, ADJUSTMENT_TYPE, BUDGET_TYPE
				, CAST(ALLOCATE_DATETIME AS DATE) AS ALLOCATE_DATE, ALLOCATE_BUDGET_AMOUNT
				FROM T_BUDGET_ALLOCATE_EXPENSES_HISTORY 
				WHERE ACTIVE = 1
			) AS A
			GROUP BY YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID, REFER_DOC_NO, PERIOD_CODE, ALLOCATE_DATE, BUDGET_TYPE
			
			UNION ALL 

			-- จัดสรรงบประมาณตามกลุ่ม (แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย)
			-- จะมีบางหมวดค่าใช้จ่าย ที่จัดสรรงบประมาณเป็นก้อนตามหมวดค่าใช้จ่าย เช่น ค่าสาธารณูปโภค เป็นต้น
			SELECT 'GROU' as ALLOCATE_SOURCE_TYPE, YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID
				, REFER_DOC_NO, PERIOD_CODE, ALLOCATE_DATE, BUDGET_TYPE
				, ALLOCATE_BUDGET_AMOUNT = SUM(CASE WHEN ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END) - SUM(CASE WHEN ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0 END)
			FROM(
				SELECT YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, CAST(NULL AS INT) AS EXPENSES_ID, CAST(NULL AS INT) AS PROJECT_ID
				, REFER_DOC_NO, PERIOD_CODE, ADJUSTMENT_TYPE, BUDGET_TYPE
				, CAST(ALLOCATE_DATETIME AS DATE) AS ALLOCATE_DATE, ALLOCATE_BUDGET_AMOUNT
				FROM T_BUDGET_ALLOCATE_EXPENSES_GROUP_HISTORY
				WHERE ACTIVE = 1
			) AS A
			GROUP BY YR, DEP_ID, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PROJECT_ID, REFER_DOC_NO, PERIOD_CODE, ALLOCATE_DATE, BUDGET_TYPE

		) AS BUDGET_EX_HIS
			ON(
				BUDGET_EX.YR = BUDGET_EX_HIS.YR AND 
				BUDGET_EX.DEP_ID = BUDGET_EX_HIS.DEP_ID AND 
				BUDGET_EX.PLAN_ID = BUDGET_EX_HIS.PLAN_ID AND 
				BUDGET_EX.PRODUCE_ID = BUDGET_EX_HIS.PRODUCE_ID AND 
				BUDGET_EX.ACTIVITY_ID = BUDGET_EX_HIS.ACTIVITY_ID AND 
				BUDGET_EX.BUDGET_TYPE_ID = BUDGET_EX_HIS.BUDGET_TYPE_ID AND 
				BUDGET_EX.EXPENSES_GROUP_ID = BUDGET_EX_HIS.EXPENSES_GROUP_ID AND 
				(
					BUDGET_EX.EXPENSES_ID = BUDGET_EX_HIS.EXPENSES_ID OR
					BUDGET_EX_HIS.ALLOCATE_SOURCE_TYPE = 'GROU' -- กรณีที่จัดสรรเป็นกลุ่มตามหมวดค่าใช้จ่าย
				) AND

				-- ไม่สามารถใช้ NULL Equals NULL ใน SQL Server ได้
				-- ในบางรายการค่าใช้จ่ายจะไม่มี โครงการ
				(
					BUDGET_EX.PROJECT_ID = BUDGET_EX_HIS.PROJECT_ID OR
					(BUDGET_EX.PROJECT_ID IS NULL AND BUDGET_EX_HIS.PROJECT_ID IS NULL) OR
					BUDGET_EX_HIS.ALLOCATE_SOURCE_TYPE = 'GROU'
				)
			)
	) AS BUDGET_EX

	-- เชื่อมหาประวัติการ บันทึกผลการใช้จ่าย
	LEFT JOIN (SELECT * FROM T_BUDGET_REPORTED_USE_EXPENSES_HISTORY WHERE ACTIVE = 1) AS BUDGET_EX_REPORT
	ON(
		BUDGET_EX_REPORT.YR = BUDGET_EX.YR AND
		BUDGET_EX_REPORT.DEP_ID = BUDGET_EX.DEP_ID AND
		BUDGET_EX_REPORT.PLAN_ID = BUDGET_EX.PLAN_ID AND
		BUDGET_EX_REPORT.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
		BUDGET_EX_REPORT.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
		BUDGET_EX_REPORT.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
		BUDGET_EX_REPORT.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
		BUDGET_EX_REPORT.EXPENSES_ID = BUDGET_EX.EXPENSES_ID AND
		(
			-- ไม่สามารถใช้ NULL Equals NULL ใน SQL Server ได้
			-- ในบางรายการค่าใช้จ่ายจะไม่มี โครงการ
			(BUDGET_EX_REPORT.PROJECT_ID = BUDGET_EX.PROJECT_ID) OR
			(BUDGET_EX_REPORT.PROJECT_ID IS NULL AND BUDGET_EX.PROJECT_ID IS NULL)
		)
	)
GO
sp_refreshview @viewname = 'V_GET_DEPARTMENT_BUDGET_CASH_FLOW_STATEMENT'
GO


/**
 * View แสดงข้อมูลกระแสเงินงบประมาณของกรมสรรพสามิต
 * ได้แก่ รับเงินประจำงวด จัดสรรงบประมาณให้หน่วยงานภูมิภาค กันเงินงบประมาณและเบิกจ่าย
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_CASH_FLOW_STATEMENT', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_CASH_FLOW_STATEMENT;
GO
CREATE VIEW V_GET_BUDGET_CASH_FLOW_STATEMENT AS
	SELECT BUDGET_EX.*
	-- ประวัติการรับเงินประจำงวด
	, BUDGET_INC.YR AS INCOME_PERIOD_YR, BUDGET_INC.PERIOD_MN AS INCOME_PERIOD_MN
	, BUDGET_INC.REFER_DOC_NO AS INCOME_REFER_DOC_NO, BUDGET_INC.RECEIVE_BUDGET_AMOUNT AS INCOME_BUDGET_AMOUNT
	, BUDGET_INC.CREATED_DATETIME AS INCOME_DATETIME

	-- ประวัติการจัดสรรงบประมาณให้กับ หน่วยงานภูมิภาค
	, BUDGET_ALC.REFER_DOC_NO AS ALLOCATE_REFER_DOC_NO
	, BUDGET_ALC.PERIOD_CODE AS ALLOCATE_PERIOD_CODE
	, BUDGET_ALC.ALLOCATE_BUDGET_AMOUNT, BUDGET_ALC.ALLOCATE_OFF_BUDGET_AMOUNT
	, BUDGET_ALC.ALLOCATE_CASHBACK_BUDGET_AMOUNT, BUDGET_ALC.ALLOCATE_CASHBACK_OFF_BUDGET_AMOUNT
	, BUDGET_ALC.ALLOCATE_DATETIME

	-- ประวัติการกันเงินงบประมาณ ของหน่วยงานภายใน
	, BUDGET_RSV.RESERVE_ID, BUDGET_RSV.RESERVE_REMARK_TEXT
	, BUDGET_RSV.RESERVE_TYPE -- 1 = ผูกพัน, 2 = กันไว้เบิก
	, BUDGET_RSV.BUDGET_TYPE AS RESERVE_BUDGET_TYPE -- 1 = เงินงบ, 2 = เงินนอกงบ

	, BUDGET_RSV.RESERVE_BUDGET_AMOUNT, BUDGET_RSV.RESERVE_CASHBACK_BUDGET_AMOUNT
	, BUDGET_RSV.RESERVE_OFF_BUDGET_AMOUNT, BUDGET_RSV.RESERVE_CASHBACK_OFF_BUDGET_AMOUNT
	, BUDGET_RSV.RESERVE_CREATED_DATETIME
	, BUDGET_RSV.RESERVE_DATE
	, BUDGET_RSV.RESERVE_REJECT_REMARK_TEXT
	, BUDGET_RSV.RESERVE_DELETED_DATETIME

	, BUDGET_RSV.WITHDRAWAL_SEQ_NO
	, BUDGET_RSV.WITHDRAWAL_CODE
	, BUDGET_RSV.WITHDRAWAL_AMOUNT
	, BUDGET_RSV.WITHDRAWAL_REMARK_TEXT
	, BUDGET_RSV.WITHDRAWAL_CREATED_DATETIME
	, BUDGET_RSV.WITHDRAWAL_DATE
	FROM
	(
		SELECT BUDGET_EX.YR

		, BUDGET_EX.PLAN_ID, PLN.PLAN_NAME, PLN.ORDER_SEQ AS PLAN_ORDER_SEQ
		, BUDGET_EX.PRODUCE_ID, PROD.PRODUCE_NAME, PROD.ORDER_SEQ AS PRODUCE_ORDER_SEQ
		, BUDGET_EX.ACTIVITY_ID, ACT.ACTIVITY_NAME, ACT.SHORT_NAME as ACTIVITY_SHORT_NAME, ACT.ORDER_SEQ as ACTIVITY_ORDER_SEQ
		, BUDGET_EX.BUDGET_TYPE_ID, B.BUDGET_TYPE_NAME, B.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ
		, BUDGET_EX.EXPENSES_GROUP_ID, EG.EXPENSES_GROUP_NAME, EG.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
		, BUDGET_EX.EXPENSES_ID, E.EXPENSES_NAME, E.ORDER_SEQ AS EXPENSES_ORDER_SEQ

		, BUDGET_EX.BUDGET_AMOUNT AS ESTIMATE_BUDGET_AMOUNT
		, BUDGET_EX.OFF_BUDGET_AMOUNT AS ESTIMATE_OFF_BUDGET_AMOUNT
		, BUDGET_EX.LATEST_RECEIVE_BUDGET
		, BUDGET_EX.LATEST_USE_BUDGET

		FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX
		LEFT JOIN T_PLAN_CONFIGURE PLN ON(PLN.PLAN_ID = BUDGET_EX.PLAN_ID)
		LEFT JOIN T_PRODUCE_CONFIGURE PROD ON(PROD.PRODUCE_ID = BUDGET_EX.PRODUCE_ID)
		LEFT JOIN T_ACTIVITY_CONFIGURE ACT ON(ACT.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID)
		LEFT JOIN T_BUDGET_TYPE B ON(B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID)
		LEFT JOIN T_EXPENSES_GROUP EG ON(EG.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID)
		LEFT JOIN T_EXPENSES_ITEM E ON(E.EXPENSES_ID = BUDGET_EX.EXPENSES_ID)
	) AS BUDGET_EX

	--  ประวัติการรับเงินประจำงวด (เงินงบประมาณ) รวมมาเฉพาะ แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย รายการค่าใช้จ่าย
	LEFT JOIN (
			SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
				, PERIOD_YR, PERIOD_MN, REFER_DOC_NO, SUM(RECEIVE_BUDGET_AMOUNT) AS RECEIVE_BUDGET_AMOUNT
				-- ไม่เอา เศษวินาที
				, CAST(FORMAT(MAX(CREATED_DATETIME), 'yyyy-MM-dd HH:mm:ss') as DATETIME) AS CREATED_DATETIME
			FROM(
				SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
				, PERIOD_YR, PERIOD_MN, REFER_DOC_NO, CREATED_DATETIME, RECEIVE_BUDGET_AMOUNT
				FROM T_BUDGET_EXPENSES_INCOME WHERE ACTIVE = 1
			) AS TMP
			GROUP BY YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, PERIOD_YR, PERIOD_MN, REFER_DOC_NO
		) AS BUDGET_INC
		ON(
			BUDGET_INC.YR = BUDGET_EX.YR AND
			BUDGET_INC.PLAN_ID = BUDGET_EX.PLAN_ID AND
			BUDGET_INC.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			BUDGET_INC.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			BUDGET_INC.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			BUDGET_INC.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			BUDGET_INC.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
		)

	-- ประวัติการจัดสรรเงินงบประมาณ รวมมาเฉพาะ แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย รายการค่าใช้จ่าย
	-- จะมีทั้งรายการที่ดึงเงินคืน (ADJUSTMENT_TYPE = -1) และ รายการที่จัดสรร (ADJUSTMENT_TYPE = 1)
	LEFT JOIN (
			SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
				, REFER_DOC_NO, PERIOD_CODE
				-- ไม่เอา เศษวินาที
				, CAST(FORMAT(MAX(ALLOCATE_DATETIME), 'yyyy-MM-dd HH:mm:ss') as DATETIME) AS ALLOCATE_DATETIME
				, SUM(ALLOCATE_BUDGET_AMOUNT) AS ALLOCATE_BUDGET_AMOUNT
				, SUM(ALLOCATE_OFF_BUDGET_AMOUNT) AS ALLOCATE_OFF_BUDGET_AMOUNT
				, SUM(ALLOCATE_CASHBACK_BUDGET_AMOUNT) AS ALLOCATE_CASHBACK_BUDGET_AMOUNT
				, SUM(ALLOCATE_CASHBACK_OFF_BUDGET_AMOUNT) AS ALLOCATE_CASHBACK_OFF_BUDGET_AMOUNT
			FROM(
				SELECT YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID
				, REFER_DOC_NO, PERIOD_CODE, ALLOCATE_DATETIME
				, CASE WHEN BUDGET_TYPE = 1 AND ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0.00 END AS ALLOCATE_BUDGET_AMOUNT
				, CASE WHEN BUDGET_TYPE = 2 AND ADJUSTMENT_TYPE = 1 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0.00 END AS ALLOCATE_OFF_BUDGET_AMOUNT
				, CASE WHEN BUDGET_TYPE = 1 AND ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0.00 END AS ALLOCATE_CASHBACK_BUDGET_AMOUNT
				, CASE WHEN BUDGET_TYPE = 2 AND ADJUSTMENT_TYPE = 2 THEN ALLOCATE_BUDGET_AMOUNT ELSE 0.00 END AS ALLOCATE_CASHBACK_OFF_BUDGET_AMOUNT
				FROM T_BUDGET_ALLOCATE_EXPENSES_HISTORY 
				WHERE ACTIVE = 1
			) AS TMP
			GROUP BY YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID, EXPENSES_GROUP_ID, EXPENSES_ID, REFER_DOC_NO, PERIOD_CODE
		) AS BUDGET_ALC
		ON(
			BUDGET_ALC.YR = BUDGET_EX.YR AND
			BUDGET_ALC.PLAN_ID = BUDGET_EX.PLAN_ID AND
			BUDGET_ALC.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			BUDGET_ALC.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			BUDGET_ALC.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			BUDGET_ALC.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			BUDGET_ALC.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
		)

	-- ประวัติการกันเงินงบประมาณ
	-- ให้นำรายการที่  ACTIVE = -1 มาด้วยเนื่องจาก รายการกันเงินบางรายการถูกยกเลิกไป แต่มีการเบิกจ่ายไปก่อนการยกเลิก
	-- ทำให้มีการใช้เงินงบประมาณไปแล้วจึงต้องนำรายการเหล่านั้นมาเพื่อให้สามารถกระทบยอดได้
	LEFT JOIN (
			SELECT A.RESERVE_ID, A.YR
			, A.PLAN_ID, A.PRODUCE_ID, A.ACTIVITY_ID, A.BUDGET_TYPE_ID, A.EXPENSES_GROUP_ID, A.EXPENSES_ID
			, A.REMARK_TEXT AS RESERVE_REMARK_TEXT
			, A.REJECT_REMARK_TEXT AS RESERVE_REJECT_REMARK_TEXT
			-- ไม่เอา เศษวินาที
			, CASE WHEN A.DELETED_DATETIME IS NOT NULL THEN CAST(FORMAT(A.DELETED_DATETIME, 'yyyy-MM-dd HH:mm:ss') AS DATETIME) ELSE NULL END AS RESERVE_DELETED_DATETIME
		
			, A.RESERVE_TYPE, A.BUDGET_TYPE
			-- ไม่เอา เศษวินาที
			, CAST(FORMAT(A.CREATED_DATETIME, 'yyyy-MM-dd HH:mm:ss') AS DATETIME) AS RESERVE_CREATED_DATETIME
			, A.RESERVE_DATE -- วันที่กันเงิน (ผู้ใช้งานเป็นผู้ใส่ข้อมูล)
			, CASE WHEN A.BUDGET_TYPE = 1 THEN A.RESERVE_BUDGET_AMOUNT ELSE 0.00 END AS RESERVE_BUDGET_AMOUNT
			, CASE WHEN A.BUDGET_TYPE = 1 THEN A.CASHBACK_AMOUNT ELSE 0.00 END AS RESERVE_CASHBACK_BUDGET_AMOUNT
			, CASE WHEN A.BUDGET_TYPE = 2 THEN A.RESERVE_BUDGET_AMOUNT ELSE 0.00 END AS RESERVE_OFF_BUDGET_AMOUNT
			, CASE WHEN A.BUDGET_TYPE = 2 THEN A.CASHBACK_AMOUNT ELSE 0.00 END AS RESERVE_CASHBACK_OFF_BUDGET_AMOUNT

			, B.SEQ_NO AS WITHDRAWAL_SEQ_NO, B.WITHDRAWAL_CODE, B.WITHDRAWAL_AMOUNT
			, B.REMARK_TEXT AS WITHDRAWAL_REMARK_TEXT
			-- ไม่เอา เศษวินาที
			, CASE WHEN B.CREATED_DATETIME IS NOT NULL THEN CAST(FORMAT(B.CREATED_DATETIME, 'yyyy-MM-dd HH:mm:ss') AS DATETIME) ELSE NULL END AS WITHDRAWAL_CREATED_DATETIME
			, B.WITHDRAWAL_DATE -- วันที่เบิกจ่ายการกันเงิน (ผู้ใช้งานเป็นผู้ใส่ข้อมูล)
			FROM T_BUDGET_RESERVE A 
			LEFT JOIN T_BUDGET_RESERVE_WITHDRAWAL B 
				ON(A.RESERVE_ID = B.RESERVE_ID AND B.ACTIVE = 1 AND B.WITHDRAWAL_AMOUNT > 0)
			WHERE A.RESERVE_BUDGET_AMOUNT > 0
		) AS BUDGET_RSV
		ON(
			BUDGET_RSV.YR = BUDGET_EX.YR AND
			BUDGET_RSV.PLAN_ID = BUDGET_EX.PLAN_ID AND
			BUDGET_RSV.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			BUDGET_RSV.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			BUDGET_RSV.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			BUDGET_RSV.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			BUDGET_RSV.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
		)
GO
sp_refreshview @viewname = 'V_GET_BUDGET_CASH_FLOW_STATEMENT'
GO



/**
 * View แสดงข้อมูล การประมาณรายการได้ภาษี
 * ในแต่ละเดือน
 *
**/
IF OBJECT_ID('dbo.V_GET_TAX_FORCAST_INCOME_MONTHLY_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_TAX_FORCAST_INCOME_MONTHLY_INFORMATION;
GO
CREATE VIEW V_GET_TAX_FORCAST_INCOME_MONTHLY_INFORMATION AS
	SELECT TAX_FORCAST.*
	, TAX_SOURCE.TAX_SOURCE_NAME, TAX_SOURCE.ORDER_SEQ AS TAX_SOURCE_ORDER_SEQ
	
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL PERSON WHERE PERSON.PERSON_ID = TAX_FORCAST.USER_ID) AS CREATED_NAME
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL PERSON WHERE PERSON.PERSON_ID = TAX_FORCAST.DELETED_ID) AS DELETED_NAME
	
	
	-- คำนวณหา ภาษีเพื่อมหาดไทย (ใช้ยอด ภาษีภายในประเทศ + ภาษีนำเข้า ไปคำนวณหา)
	, dbo.fn_CalForcastExpensesTypeValue(TAX_FORCAST.DOMESTIC_INCOME_AMOUNT + TAX_FORCAST.IMPORT_INCOME_AMOUNT, CAST(TAX_FORCAST.CREATED_DATETIME AS DATE), 1) AS DOMESTIC_EXPENSES_AMOUNT
	-- คำนวณหา เงินค่าใช้จ่ายท้องถิ่น ในประเทศ (ใช้ยอด ภาษีภายในประเทศ ไปคำนวณหา)
	, dbo.fn_CalForcastExpensesTypeValue(TAX_FORCAST.DOMESTIC_INCOME_AMOUNT, CAST(TAX_FORCAST.CREATED_DATETIME AS DATE), 2) AS DOMESTIC_EXPENSES_LOCAL_AMOUNT
	-- คำนวณหา เงินค่าใช้จ่ายท้องถิ่น นำเข้า (ใช้ยอด ภาษีนำเข้า ไปคำนวณหา)
	, dbo.fn_CalForcastExpensesTypeValue(TAX_FORCAST.IMPORT_INCOME_AMOUNT, CAST(TAX_FORCAST.CREATED_DATETIME AS DATE), 3) AS IMPORT_EXPENSES_LOCAL_AMOUNT
	FROM T_TAX_FORCAST_INCOME TAX_FORCAST
	, T_TAX_INCOME_SOURCE TAX_SOURCE
	WHERE TAX_SOURCE.TAX_SOURCE_ID = TAX_FORCAST.TAX_SOURCE_ID
GO
sp_refreshview @viewname = 'V_GET_TAX_FORCAST_INCOME_MONTHLY_INFORMATION'
GO








/**
 * View แสดงผลข้อมูลหน่วยงาน (Join ชื่อเขตพื้นที่มาแล้ว)
**/
IF OBJECT_ID('dbo.V_GET_DEPARTMENT_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_DEPARTMENT_INFORMATION;
GO
CREATE VIEW V_GET_DEPARTMENT_INFORMATION AS
	SELECT DEP.*
	, (SELECT AREA_NAME FROM T_AREA A WHERE A.AREA_ID = DEP.AREA_ID) AS AREA_NAME
	FROM T_DEPARTMENT DEP
	WHERE DEP.ACTIVE = 1
GO
sp_refreshview @viewname = 'V_GET_DEPARTMENT_INFORMATION'
GO


/**
 * View แสดงข้อมูลอัตราค่าตอบแทนตามประเภทค่าตอบแทนต่างๆ ของแต่ละระดับบุคลากร
 * เช่น ระดับชำนาญการพิเศษ ได้ค่าเบี้ยเลี้ยงเท่าไหร่ เป็นต้น
**/
IF OBJECT_ID('dbo.V_GET_PERSONNEL_LEVEL_COMPENSATION_RATE_INFOMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_PERSONNEL_LEVEL_COMPENSATION_RATE_INFOMATION;
GO
CREATE VIEW V_GET_PERSONNEL_LEVEL_COMPENSATION_RATE_INFOMATION AS
	SELECT COMPENSATION_RATE.*
	, (SELECT LEVEL_NAME FROM T_PERSONNEL_LEVEL PERSON_LEVEL WHERE PERSON_LEVEL.LEVEL_ID = COMPENSATION_RATE.LEVEL_ID) AS PERSONNEL_LEVEL_NAME
	, COMPENSATION_TYPE.COMPENSATION_TYPE_NAME, COMPENSATION_TYPE.COMPENSATION_TYPE_CODE
	FROM T_PERSONNEL_LEVEL_COMPENSATION_RATE COMPENSATION_RATE
	, T_COMPENSATION_TYPE COMPENSATION_TYPE
	WHERE COMPENSATION_TYPE.COMPENSATION_TYPE_ID = COMPENSATION_RATE.COMPENSATION_TYPE_ID
	  AND COMPENSATION_RATE.ACTIVE = 1
GO
sp_refreshview @viewname = 'V_GET_PERSONNEL_LEVEL_COMPENSATION_RATE_INFOMATION'
GO



/**
 * View แสดงข้อมูลประวัติรายการค่าใช้จ่าย ที่รับเงิน งปม. จากรัฐบาล
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_EXPENSES_RECEIVE_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_EXPENSES_RECEIVE_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_EXPENSES_RECEIVE_INFORMATION AS
	SELECT A.*
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = A.PLAN_ID) AS PLAN_NAME
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = A.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = A.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = A.EXPENSES_ID) AS EXPENSES_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = A.USER_ID) AS RECEIVE_NAME
	FROM T_BUDGET_EXPENSES_RECEIVE A
	WHERE A.ACTIVE = 1
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_EXPENSES_RECEIVE_INFORMATION'
GO


/**
 * View แสดงข้อมูลรายการกันเงินงบประมาณ
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_RESERVE_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_RESERVE_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_RESERVE_INFORMATION AS
	SELECT A.*
	, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT D WHERE D.SUB_DEP_ID = A.SUB_DEP_ID) AS SUB_DEP_NAME
	, (SELECT DEP_NAME FROM T_DEPARTMENT D WHERE D.DEP_ID = A.DEP_ID) AS DEP_NAME
	, (SELECT SORT_INDEX FROM T_DEPARTMENT D WHERE D.DEP_ID = A.DEP_ID) AS DEP_ORDER_SEQ
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = A.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = A.PLAN_ID) AS PLAN_ORDER_SEQ

	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = A.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = A.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE AX WHERE AX.ACTIVITY_ID = A.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE AX WHERE AX.ACTIVITY_ID = A.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ

	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = A.EXPENSES_ID) AS EXPENSES_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = A.EXPENSES_ID) AS EXPENSES_ORDER_SEQ

	, PROJECT_EX.PROJECT_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = A.USER_ID) AS RESERVE_NAME
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = A.LATEST_WITHDRAWAL_ID) AS LATEST_WITHDRAWAL_NAME
	FROM T_BUDGET_RESERVE A
	LEFT JOIN T_BUDGET_EXPENSES_PROJECT PROJECT_EX
	ON(
		PROJECT_EX.YR = A.YR AND
		PROJECT_EX.PLAN_ID = A.PLAN_ID AND
		PROJECT_EX.PRODUCE_ID = A.PRODUCE_ID AND
		PROJECT_EX.ACTIVITY_ID = A.ACTIVITY_ID AND
		PROJECT_EX.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID AND
		PROJECT_EX.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID AND
		PROJECT_EX.EXPENSES_ID = A.EXPENSES_ID AND
		(
			-- ไม่สามารถใช้ NULL Equals NULL ใน Sql Server ได้
			PROJECT_EX.PROJECT_ID = A.PROJECT_ID OR
			(PROJECT_EX.PROJECT_ID IS NULL AND A.PROJECT_ID IS NULL)
		)
	)
	-- WHERE A.ACTIVE = 1
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_RESERVE_INFORMATION'
GO


/**
 * View แสดงภาพรวม การกันเงิน และ การเบิกจ่าย
**/
IF OBJECT_ID('dbo.V_GET_SUMMARY_BUDGET_RESERVE_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_SUMMARY_BUDGET_RESERVE_INFORMATION;
GO
CREATE VIEW V_GET_SUMMARY_BUDGET_RESERVE_INFORMATION AS
	SELECT A.*--, CAST(A.CREATED_DATETIME AS DATE) as CREATED_DATE
	, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT D WHERE D.SUB_DEP_ID = A.SUB_DEP_ID) AS SUB_DEP_NAME
	, (SELECT DEP_NAME FROM T_DEPARTMENT D WHERE D.DEP_ID = A.DEP_ID) AS DEP_NAME
	, (SELECT SORT_INDEX FROM T_DEPARTMENT D WHERE D.DEP_ID = A.DEP_ID) AS DEP_ORDER_SEQ
	
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = A.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = A.PLAN_ID) AS PLAN_ORDER_SEQ
	
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = A.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = A.PRODUCE_ID) AS PRODUCE_ORDER_SEQ

	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE ACTIVITY WHERE ACTIVITY.ACTIVITY_ID = A.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE ACTIVITY WHERE ACTIVITY.ACTIVITY_ID = A.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ

	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ

	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ

	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = A.EXPENSES_ID) AS EXPENSES_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = A.EXPENSES_ID) AS EXPENSES_ORDER_SEQ

	, PROJECT_EX.PROJECT_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = A.USER_ID) AS RESERVE_NAME

	-- รายการเบิกจ่าย
	, WITHDRAWAL.SEQ_NO
	, WITHDRAWAL.WITHDRAWAL_AMOUNT
	, WITHDRAWAL.WITHDRAWAL_CODE -- เลขที่ขอเบิก
	, WITHDRAWAL.REMARK_TEXT AS WITHDRAWAL_REMARK_TEXT -- หมายเหตุของการเบิกจ่าย
	, WITHDRAWAL.CREATED_DATETIME AS WITHDRAWAL_DATETIME
	, WITHDRAWAL.ACTIVE as WITHDRAWAL_ACTIVE -- 1 = ใช้งาน สถานะประวัติการเบิกจ่าย
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = WITHDRAWAL.USER_ID) AS WITHDRAWAL_NAME
	FROM (SELECT * FROM T_BUDGET_RESERVE WHERE ACTIVE = 1) AS A
	LEFT JOIN T_BUDGET_RESERVE_WITHDRAWAL WITHDRAWAL
		ON (WITHDRAWAL.RESERVE_ID = A.RESERVE_ID AND WITHDRAWAL.ACTIVE = 1)
	LEFT JOIN T_BUDGET_EXPENSES_PROJECT PROJECT_EX
	ON(
		PROJECT_EX.YR = A.YR AND
		PROJECT_EX.PLAN_ID = A.PLAN_ID AND
		PROJECT_EX.PRODUCE_ID = A.PRODUCE_ID AND
		PROJECT_EX.ACTIVITY_ID = A.ACTIVITY_ID AND
		PROJECT_EX.BUDGET_TYPE_ID = A.BUDGET_TYPE_ID AND
		PROJECT_EX.EXPENSES_GROUP_ID = A.EXPENSES_GROUP_ID AND
		PROJECT_EX.EXPENSES_ID = A.EXPENSES_ID AND
		(
			-- ไม่สามารถใช้ NULL Equals NULL ใน Sql Server ได้
			PROJECT_EX.PROJECT_ID = A.PROJECT_ID OR
			(PROJECT_EX.PROJECT_ID IS NULL AND A.PROJECT_ID IS NULL)
		)
	);
GO
sp_refreshview @viewname = 'V_GET_SUMMARY_BUDGET_RESERVE_INFORMATION'
GO


/**
 * View แสดงภาพรวม การกันเงิน และ การเบิกจ่าย
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_EXPENSES_PROJECT_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_EXPENSES_PROJECT_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_EXPENSES_PROJECT_INFORMATION AS
	SELECT PROJECT_EX.*
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = PROJECT_EX.PLAN_ID) AS PLAN_NAME
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = PROJECT_EX.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = PROJECT_EX.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = PROJECT_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = PROJECT_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = PROJECT_EX.EXPENSES_ID) AS EXPENSES_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = PROJECT_EX.USER_ID) AS CREATED_NAME
	FROM T_BUDGET_EXPENSES_PROJECT PROJECT_EX
	WHERE ACTIVE = 1
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_EXPENSES_PROJECT_INFORMATION'
GO



/**
 * View ประวัติการรับเงินประจำงวดที่รัฐบาลจัดสรรมาในแต่ละรายการ คชจ.
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_EXPENSES_INCOME_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_EXPENSES_INCOME_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_EXPENSES_INCOME_INFORMATION AS
	SELECT EXPENSES_INCOME.*
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = EXPENSES_INCOME.PLAN_ID) AS PLAN_NAME
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = EXPENSES_INCOME.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = EXPENSES_INCOME.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = EXPENSES_INCOME.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP E WHERE E.EXPENSES_GROUP_ID = EXPENSES_INCOME.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = EXPENSES_INCOME.EXPENSES_ID) AS EXPENSES_NAME
	, PROJECT_EX.PROJECT_NAME

	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = EXPENSES_INCOME.USER_ID) AS CREATED_NAME
	FROM (SELECT * FROM T_BUDGET_EXPENSES_INCOME WHERE ACTIVE = 1) AS EXPENSES_INCOME
	LEFT JOIN (SELECT * FROM T_BUDGET_EXPENSES_PROJECT WHERE ACTIVE = 1) AS PROJECT_EX
	ON (
		PROJECT_EX.YR = EXPENSES_INCOME.YR AND
		PROJECT_EX.PLAN_ID = EXPENSES_INCOME.PLAN_ID AND
		PROJECT_EX.PRODUCE_ID = EXPENSES_INCOME.PRODUCE_ID AND
		PROJECT_EX.ACTIVITY_ID = EXPENSES_INCOME.ACTIVITY_ID AND
		PROJECT_EX.BUDGET_TYPE_ID = EXPENSES_INCOME.BUDGET_TYPE_ID AND
		PROJECT_EX.EXPENSES_GROUP_ID = EXPENSES_INCOME.EXPENSES_GROUP_ID AND
		PROJECT_EX.EXPENSES_ID = EXPENSES_INCOME.EXPENSES_ID AND
		PROJECT_EX.PROJECT_ID = EXPENSES_INCOME.PROJECT_ID
	)
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_EXPENSES_INCOME_INFORMATION'
GO


/**
 * View ประวัติของการแก้ไขรายการ กันเงินงบประมาณ
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_RESERVE_HISTORY_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_RESERVE_HISTORY_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_RESERVE_HISTORY_INFORMATION AS
	SELECT RESERVE_HIS.*
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = RESERVE_HIS.USER_ID) AS CREATED_NAME
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = RESERVE_HIS.LATEST_WITHDRAWAL_ID) AS LATEST_WITHDRAWAL_NAME
	FROM T_BUDGET_RESERVE_HISTORY RESERVE_HIS
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_RESERVE_HISTORY_INFORMATION'
GO


/**
 * View ประวัติการเบิกจ่าย รายการกันเงินงบประมาณ
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_RESERVE_WITHDRAWAL_INFORMATION AS
	SELECT RESERVE.PLAN_ID, RESERVE.PRODUCE_ID, RESERVE.ACTIVITY_ID
	, RESERVE.BUDGET_TYPE_ID, RESERVE.EXPENSES_GROUP_ID, RESERVE.EXPENSES_ID
	, RESERVE.BUDGET_TYPE, RESERVE.RESERVE_TYPE
	, WITHDRAWAL.*
	, (SELECT SUB_DEP_NAME FROM T_SUB_DEPARTMENT SUB_DEP WHERE SUB_DEP.SUB_DEP_ID = WITHDRAWAL.SUB_DEP_ID) AS SUB_DEP_NAME
	, (SELECT DEP_NAME FROM T_DEPARTMENT DEP WHERE DEP.DEP_ID = WITHDRAWAL.DEP_ID) AS DEP_NAME
	, (SELECT SORT_INDEX FROM T_DEPARTMENT DEP WHERE DEP.DEP_ID = WITHDRAWAL.DEP_ID) AS DEP_ORDER_SEQ
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = WITHDRAWAL.USER_ID) AS CREATED_NAME
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = WITHDRAWAL.DELETED_ID) AS DELETED_NAME
	FROM T_BUDGET_RESERVE_WITHDRAWAL WITHDRAWAL
	, T_BUDGET_RESERVE RESERVE
	WHERE RESERVE.RESERVE_ID = WITHDRAWAL.RESERVE_ID
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_RESERVE_WITHDRAWAL_INFORMATION'
GO


/**
 * View ประวัติการปรับปรุงรายการเบิกจ่าย
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION AS
	SELECT WITHDRAWAL_HIS.*
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = WITHDRAWAL_HIS.USER_ID) AS CREATED_NAME
	FROM T_BUDGET_RESERVE_WITHDRAWAL_HISTORY WITHDRAWAL_HIS
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION'
GO

/**
 * View ประวัติการปรับปรุงรายการเบิกจ่าย
**/
IF OBJECT_ID('dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION;
GO
CREATE VIEW V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION AS
	SELECT WITHDRAWAL_HISTORY.*
	, (SELECT CONCAT(PREFIX_NAME, FIRST_NAME, ' ', LAST_NAME) FROM T_PERSONNEL P WHERE P.PERSON_ID = WITHDRAWAL_HISTORY.USER_ID) AS CREATED_NAME
	FROM T_BUDGET_RESERVE_WITHDRAWAL_HISTORY WITHDRAWAL_HISTORY
	;
GO
sp_refreshview @viewname = 'V_GET_BUDGET_RESERVE_WITHDRAWAL_HISTORY_INFORMATION'
GO



/**
 * View นำไปออกรายงาน สรุปการรับเงินประจำงวด แยกตามงบรายจ่าย (เงินงบประมาณ)
**/
IF OBJECT_ID('dbo.V_GET_SUMMARY_BUDGET_INCOME_GROUP_BY_BUDGET_TYPE', N'V') IS NOT NULL 
	DROP VIEW dbo.V_GET_SUMMARY_BUDGET_INCOME_GROUP_BY_BUDGET_TYPE;
GO
CREATE VIEW V_GET_SUMMARY_BUDGET_INCOME_GROUP_BY_BUDGET_TYPE AS
	SELECT BUDGET_TYPE.BUDGET_TYPE_NAME, BUDGET_TYPE.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ, BUDGET_EX.*
	FROM (SELECT * FROM T_BUDGET_TYPE WHERE ACTIVE = 1) AS BUDGET_TYPE
	LEFT JOIN 
	(
		SELECT BUDGET_EX.YR -- ปีงบประมาณ
		, BUDGET_EX.BUDGET_ID
	
		, BUDGET_EX.SEQ_ID
		, BUDGET_EX.PLAN_ID, BUDGET_EX.PRODUCE_ID, BUDGET_EX.ACTIVITY_ID, BUDGET_EX.BUDGET_TYPE_ID
		, BUDGET_EX.EXPENSES_GROUP_ID, BUDGET_EX.EXPENSES_ID

		, BUDGET_EX_SUMMARY.NET_BUDGET_AMOUNT -- เงินที่รัฐบาลจะจัดสรรมาให้ ในภาพรวม งบรายจ่าย

		-- ประวัติการรับเงินประจำงวดของแต่ละหมวด (แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย รายการค่าใช้จ่าย)
		, BUDGET_INC.INCOME_ID
		, BUDGET_INC.PERIOD_YR, BUDGET_INC.PERIOD_MN
		, BUDGET_INC.REFER_DOC_NO
		, BUDGET_INC.RECEIVE_BUDGET_AMOUNT
		, BUDGET_INC.BUDGET_TYPE -- 1 = เงินงบประมาณ, 2 = เงินนอกงบประมาณ
		, CAST(BUDGET_INC.CREATED_DATETIME AS DATE) CREATED_DATE
	
		FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1) AS BUDGET_EX
		-- งบประมาณที่ตั้งต้นที่รัฐบาลจะจัดสรรให้
		INNER JOIN (SELECT YR, BUDGET_TYPE_ID, SUM(BUDGET_AMOUNT) AS NET_BUDGET_AMOUNT FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1 GROUP BY YR, BUDGET_TYPE_ID) AS BUDGET_EX_SUMMARY
		ON (BUDGET_EX_SUMMARY.YR = BUDGET_EX.YR AND BUDGET_EX_SUMMARY.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID)
		-- ประวัติการรับเงินประจำงวด
		LEFT JOIN (SELECT * FROM T_BUDGET_EXPENSES_INCOME WHERE ACTIVE = 1) AS BUDGET_INC
		ON(
			BUDGET_EX.YR = BUDGET_INC.YR AND 
			BUDGET_EX.PLAN_ID = BUDGET_INC.PLAN_ID AND 
			BUDGET_EX.PRODUCE_ID = BUDGET_INC.PRODUCE_ID AND 
			BUDGET_EX.ACTIVITY_ID = BUDGET_INC.ACTIVITY_ID AND 
			BUDGET_EX.BUDGET_TYPE_ID = BUDGET_INC.BUDGET_TYPE_ID AND 
			BUDGET_EX.EXPENSES_GROUP_ID = BUDGET_INC.EXPENSES_GROUP_ID AND 
			BUDGET_EX.EXPENSES_ID = BUDGET_INC.EXPENSES_ID
		  )
	  ) AS BUDGET_EX
	  ON(BUDGET_EX.BUDGET_TYPE_ID = BUDGET_TYPE.BUDGET_TYPE_ID)

GO
sp_refreshview @viewname = 'V_GET_SUMMARY_BUDGET_INCOME_GROUP_BY_BUDGET_TYPE'
GO


/**
 * ดึงข้อมูลปีปัจจุบัน เช่น 
 * 1. หน่วยงานราชการจะใช้ ปีงบประมาณ (01/10/2019 - 30/03/2020)
 * 2. ทั่วไปจะใช้ปีปฏิทิน
**/
IF OBJECT_ID ( 'dbo.fn_GetCurrentYear', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetCurrentYear; 
GO 
CREATE FUNCTION dbo.fn_GetCurrentYear(@p_test_date datetime) 
RETURNS SMALLINT AS
BEGIN
	DECLARE @CURR_YEAR SMALLINT;
	DECLARE @CURR_MONTH SMALLINT;
	DECLARE @CURR_DATETIME DATETIME;

	SELECT @CURR_DATETIME = CASE WHEN @p_test_date IS NULL THEN GETDATE() ELSE @p_test_date END;

	SELECT @CURR_YEAR = YEAR(@CURR_DATETIME), @CURR_MONTH = MONTH(@CURR_DATETIME);
	
	-- กรณีเป็นเดือน >= 10 ให้บวกเพิ่มไปอีก 1 ปี
	-- เพราะในระบบ ใช้ปีงบประมาณ
	IF @CURR_MONTH >= 10 BEGIN
		SET @CURR_YEAR += 1;
	END;

	RETURN @CURR_YEAR;
END
GO


/**
 * ค้นหาเลขที่อ้างอิงแหล่งเงิน ของ งบรายจ่าย โดยใช้เงื่อนไขปีงบประมาณค้นหา
 * @p_fiscal_year ไม่ผ่านค่าเข้ามาจะใช้ปีงบประมาณ ปัจจุบัน
**/
IF OBJECT_ID ( 'dbo.fn_GetBudgetTypeGovenmentReferCode', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetBudgetTypeGovenmentReferCode; 
GO 
CREATE FUNCTION dbo.fn_GetBudgetTypeGovenmentReferCode(@p_budget_type_id int, @p_fiscal_year int) 
RETURNS NVARCHAR(50) AS
BEGIN
	DECLARE  @VAR_GOVERNMENT_REFER_CODE NVARCHAR(50) = NULL;
	IF @p_fiscal_year IS NULL 
	BEGIN
		SELECT @p_fiscal_year = dbo.fn_GetCurrentYear(null); 
	END;

	SELECT TOP 1 @VAR_GOVERNMENT_REFER_CODE = GOVERNMENT_REFER_CODE
	FROM T_BUDGET_TYPE_GOVERNMENT_REFER_CODE
	WHERE BUDGET_TYPE_ID = @p_budget_Type_id
	  AND YR = @p_fiscal_year;

	RETURN @VAR_GOVERNMENT_REFER_CODE;
END
GO


/**
 * งบรายจ่ายที่ต้องการตรวจสอบ เป็นการใช้จ่ายงบประมาณแบบถั่วเฉลี่ยหรือไม่
 * @p_budget_type_id รหัสอ้างอิงงบรายจ่าย ที่ระบบสร้างขึ้น
**/
IF OBJECT_ID ( 'dbo.fn_GetBudgetTypeShareBudget', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetBudgetTypeShareBudget; 
GO 
CREATE FUNCTION dbo.fn_GetBudgetTypeShareBudget(@p_budget_type_id int) 
RETURNS BIT AS
BEGIN
	DECLARE  @VAR_SHARED_BUDGET BIT = 0;
	SELECT TOP 1 @VAR_SHARED_BUDGET = CAN_PAY_OVER_BUDGET_EXPENSES
	FROM T_BUDGET_TYPE
	WHERE BUDGET_TYPE_ID = @p_budget_Type_id
	;

	RETURN @VAR_SHARED_BUDGET;
END
GO


/**
 * ค้นหาเลขที่อ้างอิงแหล่งเงิน ของ หมวดค่าใช้จ่าย โดยใช้เงื่อนไขปีงบประมาณค้นหา
 * @p_fiscal_year ไม่ผ่านค่าเข้ามาจะใช้ปีงบประมาณ ปัจจุบัน
**/
IF OBJECT_ID ( 'dbo.fn_GetExpensesGroupGovenmentReferCode', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetExpensesGroupGovenmentReferCode; 
GO 
CREATE FUNCTION dbo.fn_GetExpensesGroupGovenmentReferCode(@p_expenses_group_id int, @p_fiscal_year int) 
RETURNS NVARCHAR(50) AS
BEGIN
	DECLARE  @VAR_GOVERNMENT_REFER_CODE NVARCHAR(50) = NULL;
	IF @p_fiscal_year IS NULL 
	BEGIN
		SELECT @p_fiscal_year = dbo.fn_GetCurrentYear(null); 
	END;

	SELECT TOP 1 @VAR_GOVERNMENT_REFER_CODE = GOVERNMENT_REFER_CODE
	FROM V_GET_EXPENSES_GROUP_GOVERNMENT_REFER_CODE
	WHERE EXPENSES_GROUP_ID = @p_expenses_group_id
	  AND YR = @p_fiscal_year;

	RETURN @VAR_GOVERNMENT_REFER_CODE;
END
GO


/**
 * ค้นหาเลขที่ GL ของรายการ คชจ.
 * บางรายการ คชจ. จะมี GL Code มากกว่า 1 รายการ
**/
IF OBJECT_ID ( 'dbo.fn_GetExpensesGLCodes', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetExpensesGLCodes; 
GO 
CREATE FUNCTION dbo.fn_GetExpensesGLCodes(@p_expenses_id INT) 
RETURNS NVARCHAR(MAX) AS
BEGIN

	DECLARE @VAR_RET_GLCODEs NVARCHAR(MAX) = NULL;
	DECLARE @VAR_GLCODE NVARCHAR(50);

	DECLARE CURSOR_EXPENSES_GLCODE CURSOR LOCAL FOR
		SELECT GLCODE FROM T_EXPENSES_GLCODE
		WHERE EXPENSES_ID = @p_expenses_id
	;
	OPEN CURSOR_EXPENSES_GLCODE;
	FETCH NEXT FROM CURSOR_EXPENSES_GLCODE INTO @VAR_GLCODE;
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @VAR_RET_GLCODEs = CONCAT(CASE WHEN @VAR_RET_GLCODEs IS NULL THEN '' ELSE CONCAT(@VAR_RET_GLCODEs, ',') END, @VAR_GLCODE);
		FETCH NEXT FROM CURSOR_EXPENSES_GLCODE INTO @VAR_GLCODE;
	END;
	CLOSE CURSOR_EXPENSES_GLCODE;
	DEALLOCATE CURSOR_EXPENSES_GLCODE;

	RETURN @VAR_RET_GLCODEs;
END
GO
-- SELECT dbo.fn_GetExpensesGLCodes(1);


/**
 * ค้นหาจำนวนเงินงบประมาณของ คชจ./โครงการ ที่จัดสรรลงให้กับหน่วยงานในปีงบประมาณใดๆ
 * @p_fiscal_year ปีงบประมาณ ค.ศ.
 * @p_budget_type 1 = เงินงบประมาณ, 2 = เงินนอกงบประมาณ, 3 = เงินงบและเงินนอกงบประมาณ รวมกัน
**/
IF OBJECT_ID ( 'dbo.fn_GetAllocateBudgetAmountsToDepartmentBy', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_GetAllocateBudgetAmountsToDepartmentBy; 
GO 
CREATE FUNCTION dbo.fn_GetAllocateBudgetAmountsToDepartmentBy(@p_fiscal_year int, @p_dep_id int
, @p_plan_id int, @p_produce_id int, @p_activity_id int
, @p_budget_type_id int, @p_expenses_group_id int, @p_expenses_id int
, @p_project_id int, @p_budget_type smallint) 
RETURNS DECIMAL(20,2) AS
BEGIN
	DECLARE  @VAR_ALLOCATE_AMOUNTs DECIMAL(20,2) = 0.00;
	
	SELECT TOP 1 @VAR_ALLOCATE_AMOUNTs = 
		CASE WHEN @p_budget_type = 1 THEN ALLOCATE_BUDGET_AMOUNT -- เงินงบสุทธิ ที่ได้รับจัดสรร
			WHEN @p_budget_type = 2 THEN ALLOCATE_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณสุทธิ ที่ได้รับจัดสรร
			ELSE ALLOCATE_BUDGET_AMOUNT + ALLOCATE_OFF_BUDGET_AMOUNT -- เงินงบประมาณ + เงินนอกงบประมาณ
		END
	FROM T_BUDGET_ALLOCATE_EXPENSES
	WHERE YR = @p_fiscal_year
	  AND DEP_ID = @p_dep_id
	  AND PLAN_ID = @p_plan_id
	  AND PRODUCE_ID = @p_produce_id
	  AND ACTIVITY_ID = @p_activity_id
	  AND BUDGET_TYPE_ID = @p_budget_type_id
	  AND EXPENSES_GROUP_ID = @p_expenses_group_id
	  AND EXPENSES_ID = @p_expenses_id
	  AND (
		(PROJECT_ID = @p_project_id) OR
		(PROJECT_ID IS NULL AND @p_project_id IS NULL)
	  );

	RETURN @VAR_ALLOCATE_AMOUNTs;
END
GO


/**
 * คำนวณหามูลค่าประเภทรายจ่าย ของการประมาณการรายได้ภาษี
 * @p_amount ยอดเงินที่จะนำมาเข้าสูตรคำนวณ
 * @p_date วันที่ใช้ต้องการค้นหาสูตร
 * @p_forcast_expenses_type_id รหัสประเภทค่าใช้จ่าย ของการประมาณการรายได้ภาษี
**/
IF OBJECT_ID ( 'dbo.fn_CalForcastExpensesTypeValue', N'FN' ) IS NOT NULL   
    DROP FUNCTION dbo.fn_CalForcastExpensesTypeValue; 
GO 
CREATE FUNCTION dbo.fn_CalForcastExpensesTypeValue(@p_amount decimal(20,2)
, @p_date date
, @p_forcast_expenses_type_id smallint) 
RETURNS DECIMAL(20,2) AS
BEGIN
	DECLARE @VAR_FORCAST_EXPENSES_TYPE_VALUE DECIMAL(20,2) = 0.00;
	IF @p_date IS NULL OR @p_amount IS NULL OR @p_amount = 0 OR @p_forcast_expenses_type_id IS NULL 
		RETURN @VAR_FORCAST_EXPENSES_TYPE_VALUE;

	-- ค้นหาสูตรในการคำนวณในแต่ละปีงบประมาณ
	-- ของรายการค่าใช้จ่าย การประมาณการรายได้ภาษี
	DECLARE @VAR_PERCENT_VAL FLOAT;
	DECLARE @FIRST_LOOP SMALLINT = 1;
	DECLARE CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA CURSOR LOCAL FOR
		SELECT PERCENT_VAL
		FROM V_GET_TAX_FORCAST_EXPENSES_TYPE_FORMULA_INFORMATION
		WHERE ACTIVE = 1
		  AND @p_date BETWEEN START_DATE AND EXPIRE_DATE
		  AND FORCAST_EXPENSES_TYPE_ID = @p_forcast_expenses_type_id
		ORDER BY CAL_PRIORITY ASC;
	OPEN CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA;
	FETCH NEXT FROM CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA INTO @VAR_PERCENT_VAL;
	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @FIRST_LOOP = 1
			SET @VAR_FORCAST_EXPENSES_TYPE_VALUE = @p_amount;

		-- คำนวณหามูลค่า ตามค่าร้อยละที่กำหนด
		SET @VAR_FORCAST_EXPENSES_TYPE_VALUE = CAST(@VAR_FORCAST_EXPENSES_TYPE_VALUE * @VAR_PERCENT_VAL / 100.00 AS DECIMAL(20,6));

		SET @FIRST_LOOP = 2;
		FETCH NEXT FROM CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA INTO @VAR_PERCENT_VAL;
	END;
	CLOSE CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA;
	DEALLOCATE CURSOR_FORCAST_EXPENSES_TYPE_PERCENT_FORMULA;


	-- ตอบกลับผลลัพธ์
	RETURN @VAR_FORCAST_EXPENSES_TYPE_VALUE;
END
GO


/**
 * View ติดตามข้อมูลคำขอต้นปี ของแต่ละหน่วยงาน ได้แก่ หน่วยงานที่ทำคำขอแล้ว (ยืนยัน และ ยังไม่ยืนยัน) หน่วยงานที่ยังไม่ทำคำขอ
 *
**/
IF OBJECT_ID ( 'dbo.proc_GetTrackingBudgetRequestStartYear', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetTrackingBudgetRequestStartYear; 
GO
CREATE PROCEDURE proc_GetTrackingBudgetRequestStartYear @p_fiscal_year SMALLINT
WITH RECOMPILE
AS
	SET NOCOUNT ON;

	SELECT *
	FROM(
		-- หน่วยงานที่ทำคำขอแล้ว (ยืนยัน และ ยังไม่ยืนยัน) ** TEMPLATE_ID ย้ายไปอยู่ใน DETAIL
		SELECT REQ_MAS.REQ_ID, REQ_MAS.YR, CAST(NULL AS INT) AS TEMPLATE_ID
		, REQ_MAS.AREA_ID, REQ_MAS.AREA_NAME
		, REQ_MAS.DEP_ID, REQ_MAS.DEP_NAME, (SELECT SORT_INDEX FROM T_DEPARTMENT D WHERE D.DEP_ID = REQ_MAS.DEP_ID) AS DEP_SORT_INDEX

		-- รายละเอียด
		--, REQ_MAS.PLAN_ID, REQ_MAS.PLAN_NAME
		--, REQ_MAS.PRODUCE_ID, REQ_MAS.PRODUCE_NAME
		--, REQ_MAS.ACTIVITY_ID, REQ_MAS.ACTIVITY_NAME
		--, REQ_MAS.BUDGET_TYPE_ID, REQ_MAS.BUDGET_TYPE_NAME
		--, REQ_MAS.EXPENSES_GROUP_ID, REQ_MAS.EXPENSES_GROUP_NAME

		-- ยอดคำขอ งปม.
		, REQ_MAS.TOTAL_REQUEST_BUDGET
		, REQ_MAS.CREATED_NAME, REQ_MAS.CREATED_DATETIME

		-- การจัดสรร งปม.
		, REQ_MAS.PROCESS_STATUS, REQ_MAS.APPROVE_NAME, REQ_MAS.APPROVE_DATETIME
		, REQ_MAS.NET_ALLOCATE_BUDGET_AMOUNT -- ยอดจัดสรร งปม.


		-- คำขอปัจจุบัน SignOff คำขอหรือยัง
		, REQ_MAS.SIGNOFF_FLAG, REQ_MAS.SIGNOFF_NAME, REQ_MAS.SIGNOFF_DATETIME

		FROM V_GET_BUDGET_REQUEST_INFORMATION REQ_MAS
		WHERE REQ_MAS.ACTIVE = 1 -- เฉพาะรายการที่ใช้งาน
		  AND REQ_MAS.REQ_TYPE = 1 -- เฉพาะคำขอต้นปี
		  AND REQ_MAS.YR = @p_fiscal_year

		UNION ALL

		-- หน่วยงานที่ยังไม่ทำคำขอต้นปี
		SELECT CAST(NULL AS NVARCHAR) AS REQ_ID, @p_fiscal_year as YR, CAST(NULL AS INT) AS TEMPLATE_ID
		, DEP.AREA_ID, DEP.AREA_NAME
		, DEP.DEP_ID, DEP.DEP_NAME, DEP.SORT_INDEX AS DEP_SORT_INDEX

		-- รายละเอียด
		--, NULL AS PLAN_ID, NULL AS PLAN_NAME
		--, NULL AS PRODUCE_ID, NULL AS PRODUCE_NAME
		--, NULL AS ACTIVITY_ID, NULL AS ACTIVITY_NAME
		--, NULL AS BUDGET_TYPE_ID, NULL AS BUDGET_TYPE_NAME
		--, NULL AS EXPENSES_GROUP_ID, NULL AS EXPENSES_GROUP_NAME

		-- ยอดคำขอ งปม.
		, CAST(0 AS DECIMAL(15,2)) AS TOTAL_REQUEST_BUDGET
		, NULL AS CREATED_NAME, NULL AS CREATED_DATETIME

		-- การจัดสรร งปม.
		, CAST(NULL AS SMALLINT) AS PROCESS_STATUS, NULL AS APPROVE_NAME, NULL AS APPROVE_DATETIME
		, CAST(0 AS DECIMAL(12,2)) AS NET_ALLOCATE_BUDGET_AMOUNT -- ยอดจัดสรร งปม.


		-- คำขอปัจจุบัน SignOff คำขอหรือยัง
		, NULL AS SIGNOFF_FLAG, NULL AS SIGNOFF_NAME, NULL AS SIGNOFF_DATETIME

		FROM V_GET_DEPARTMENT_INFORMATION DEP
		WHERE NOT EXISTS(
			SELECT *
			FROM T_BUDGET_REQUEST_MASTER REQ_MAS
			WHERE REQ_MAS.YR = @p_fiscal_year
			  AND REQ_MAS.ACTIVE = 1 -- เฉพาะที่ใช้งานอยู่
			  AND REQ_MAS.REQ_TYPE = 1 -- เฉพาะคำขอต้นปี
			  AND REQ_MAS.DEP_ID = DEP.DEP_ID
		)
	) AS FINAL
	ORDER BY FINAL.AREA_ID ASC, FINAL.DEP_SORT_INDEX
GO

/**
 * ค้นหาข้อมูล เงินงบประมาณที่ได้รับจัดสรรจากรัฐบาล ในแต่ละปี งปม.
 * 1.) ถ้าปีงบประมาณใด ยังไม่บันทึกงบประมาณ ให้ดึง Default จากคำขอ
 * 2.) ปีงบประมาณใด บันทึกงบประมาณแล้ว ให้ดึงจาก T_BUDGET_EXPENSES
 * ข้อมูลจะได้มาจาก 2 ส่วน ได้แก่ ส่วนที่ทำรายการรับเงินงบประมาณจากรัฐบาลแล้ว (T_BUDGET_EXPENSES), ข้อมูลคำขอต้นปี & SignOff แล้ว (T_BUDGET_REQUEST_DETAIL)
 *
 *
 * ข้อควมระวัง:
 * หากมีการ Drag & Drop Procedure นี้ลง *.dbml ใหม่ให้ Comment code ส่วน IF EXISTS.. ไว้ก่อน
 * เพื่อให้ สร้าง DataType ใน C# Class ได้ถูกต้อง ฉะนั้นจะทำให้โปรแกรม Error
**/
IF OBJECT_ID ( 'dbo.proc_GetExpensesAllocateBudgetFromGovernmentByYear', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetExpensesAllocateBudgetFromGovernmentByYear; 
GO
CREATE PROCEDURE proc_GetExpensesAllocateBudgetFromGovernmentByYear @p_fiscal_year SMALLINT
WITH RECOMPILE
AS
	SET NOCOUNT ON;
	-- SET FMTONLY ON;

	-- ปีที่ผ่านเข้ามา บันทึกข้อมูลงบประมาณไว้แล้วหรือยัง
	--IF EXISTS(SELECT * FROM T_BUDGET_MASTER WHERE YR = @p_fiscal_year)
	--BEGIN

		-- รายการ คชจ. ที่ทำรายการรับเงินจากรัฐบาล (เงินงบประมาณภาพรวม ที่ยังไม่สามารถนำไปใช้จัดสรร หรือ กันเงิน ได้)
		SELECT BUDGET_EX.BUDGET_ID, BUDGET_EX.SEQ_ID, BUDGET_EX.YR
		
		, BUDGET_EX.PLAN_ID
		, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_NAME
		, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_ORDER_SEQ
		
		, BUDGET_EX.PRODUCE_ID
		, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_NAME
		, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_ORDER_SEQ
		
		, BUDGET_EX.ACTIVITY_ID
		, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_NAME
		, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ
		
		, BUDGET_EX.BUDGET_TYPE_ID
		, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
		, (SELECT GOVERNMENT_REFER_CODE FROM T_BUDGET_TYPE_GOVERNMENT_REFER_CODE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND YR = @p_fiscal_year) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
		, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ
		
		, BUDGET_EX.EXPENSES_GROUP_ID
		, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP G WHERE G.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
		, (SELECT GOVERNMENT_REFER_CODE FROM T_EXPENSES_GROUP_GOVERNMENT_REFER_CODE B WHERE B.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND YR = @p_fiscal_year) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE
		, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP G WHERE G.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ
		
		, BUDGET_EX.EXPENSES_ID
		, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_NAME
		, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_ORDER_SEQ
		, BUDGET_EX.CAN_ADD_PROJECT

		-- ข้อมูลงบประมาณ
		, BUDGET_EX.BUDGET_AMOUNT -- เงิน งปม. ที่ได้รับจัดสรร
		, BUDGET_EX.ACTUAL_BUDGET_AMOUNT -- เงิน งปม. ที่ได้รับจริง
		, BUDGET_EX.USE_BUDGET_AMOUNT
		, BUDGET_EX.REMAIN_BUDGET_AMOUNT

		, BUDGET_EX.OFF_BUDGET_AMOUNT -- เงินนอก งปม. ตั้งต้น (ไม่สามารถใช้ได้)
		, BUDGET_EX.ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอก งปม. ที่สามารถใช้ได้
		, BUDGET_EX.USE_OFF_BUDGET_AMOUNT
		, BUDGET_EX.REMAIN_OFF_BUDGET_AMOUNT
		
		, BUDGET_EX.LATEST_RECEIVE_BUDGET -- รับเงิน งปม. ล่าสุดเมื่อไหร่
		, BUDGET_EX.LATEST_USE_BUDGET -- ใช้เงิน งปม. ล่าสุดเมื่อไหร่

		FROM T_BUDGET_EXPENSES BUDGET_EX
		WHERE YR = @p_fiscal_year
		  AND ACTIVE = 1


		UNION ALL

		-- รายการ คชจ. ที่ได้จากคำของบประมาณต้นปี และ SignOff คำขอแล้ว
		-- GROUP ข้อมูลรายการค่าใช้จ่าย ที่อยู่ในกลุ่ม แผนงาน ผลผลิต กิจกรรม งบรายจ่าย หมวดค่าใช้จ่าย
		-- หน่วยงานภายนอกจะมีการใช้ Template ที่ซ้ำกับหน่วยงานอื่นๆ ทำให้ข้อมูลออกมาซ้ำกันในกลุ่มข้อมูลเดียวกัน
		SELECT DISTINCT *
		FROM(
			SELECT CAST(NULL AS INT) AS BUDGET_ID, CAST(NULL AS INT) AS SEQ_ID, @p_fiscal_year as YR
			, REQ_DETAIL.PLAN_ID, REQ_DETAIL.PLAN_NAME, REQ_DETAIL.PLAN_ORDER_SEQ
			, REQ_DETAIL.PRODUCE_ID, REQ_DETAIL.PRODUCE_NAME, REQ_DETAIL.PRODUCE_ORDER_SEQ
			, REQ_DETAIL.ACTIVITY_ID, REQ_DETAIL.ACTIVITY_NAME, REQ_DETAIL.ACTIVITY_ORDER_SEQ
		
			, REQ_DETAIL.BUDGET_TYPE_ID, REQ_DETAIL.BUDGET_TYPE_NAME
			, (SELECT GOVERNMENT_REFER_CODE FROM T_BUDGET_TYPE_GOVERNMENT_REFER_CODE E WHERE E.BUDGET_TYPE_ID = REQ_DETAIL.BUDGET_TYPE_ID AND E.YR = @p_fiscal_year) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
			, REQ_DETAIL.BUDGET_TYPE_ORDER_SEQ
		
			, REQ_DETAIL.EXPENSES_GROUP_ID, REQ_DETAIL.EXPENSES_GROUP_NAME
			, (SELECT GOVERNMENT_REFER_CODE FROM T_EXPENSES_GROUP_GOVERNMENT_REFER_CODE E WHERE E.EXPENSES_GROUP_ID = REQ_DETAIL.EXPENSES_GROUP_ID AND E.YR = @p_fiscal_year) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE
			, REQ_DETAIL.EXPENSES_GROUP_ORDER_SEQ
		
			, REQ_DETAIL.EXPENSES_ID, REQ_DETAIL.EXPENSES_NAME
			, REQ_DETAIL.EXPENSES_ORDER_SEQ
			, (SELECT CAN_ADD_PROJECT FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = REQ_DETAIL.EXPENSES_ID) AS CAN_ADD_PROJECT

			-- เงินงบประมาณกรมสรรพสามิต
			, CAST(0 AS DECIMAL(20,2)) AS BUDGET_AMOUNT -- ได้รับจัดสรรสุทธิ
			, CAST(0 AS DECIMAL(20,2)) AS ACTUAL_BUDGET_AMOUNT -- ยอดสุทธิที่ใช้ได้
			, CAST(0 AS DECIMAL(20,2)) AS USE_BUDGET_AMOUNT
			, CAST(0 AS DECIMAL(20,2)) AS REMAIN_BUDGET_AMOUNT
		
			-- เงินนอกงบประมาณ กรมสรรพสามิต
			, CAST(0 AS DECIMAL(20,2)) AS OFF_BUDGET_AMOUNT -- เงินนอก งปม. ตั้งต้น (ไม่สามารถใช้ได้)
			, CAST(0 AS DECIMAL(20,2)) AS ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอก งปม. ที่สามารถใช้ได้
			, CAST(0 AS DECIMAL(20,2)) AS USE_OFF_BUDGET_AMOUNT
			, CAST(0 AS DECIMAL(20,2)) AS REMAIN_OFF_BUDGET_AMOUNT
		
			, CAST(NULL AS DATETIME) AS LATEST_RECEIVE_BUDGET -- รับเงิน งปม. ล่าสุดเมื่อไหร่
			, CAST(NULL AS DATETIME) AS LATEST_USE_BUDGET -- ใช้เงิน งปม. ล่าสุดเมื่อไหร่

			FROM V_GET_BUDGET_REQUEST_INFORMATION REQ_MAS
			, V_GET_BUDGET_REQUEST_DETAIL_INFORMATION REQ_DETAIL
			WHERE REQ_MAS.REQ_ID = REQ_DETAIL.REQ_ID
			  AND REQ_MAS.YR = @p_fiscal_year
			  AND REQ_MAS.REQ_TYPE = 1 -- เฉพาะคำขอต้นปี
			  AND REQ_MAS.SIGNOFF_FLAG = 1 -- เฉพาะที่ SignOff แล้ว

			  -- นำมาเฉพาะรายการ คชจ. ที่ยังไม่มีการบันทึกข้อมูลรับเงินจากรัฐบาลในปีนั้นๆ
			  AND NOT EXISTS(
				SELECT *
				FROM T_BUDGET_EXPENSES BUDGET_EX
				WHERE BUDGET_EX.YR = REQ_DETAIL.YR
				  AND BUDGET_EX.PLAN_ID = REQ_DETAIL.PLAN_ID
				  AND BUDGET_EX.PRODUCE_ID = REQ_DETAIL.PRODUCE_ID
				  AND BUDGET_EX.ACTIVITY_ID = REQ_DETAIL.ACTIVITY_ID
				  AND BUDGET_EX.BUDGET_TYPE_ID = REQ_DETAIL.BUDGET_TYPE_ID
				  AND BUDGET_EX.EXPENSES_GROUP_ID = REQ_DETAIL.EXPENSES_GROUP_ID
				  AND BUDGET_EX.EXPENSES_ID = REQ_DETAIL.EXPENSES_ID
			  )
		) AS REQ_EXPENSES
		;
	--END 
	--ELSE 
	--BEGIN
		--SELECT CAST(NULL AS INT) AS BUDGET_ID, CAST(NULL AS INT) AS SEQ_ID, @p_fiscal_year as YR
		--, REQ_MAS.PLAN_ID, REQ_MAS.PLAN_NAME
		--, REQ_MAS.PRODUCE_ID, REQ_MAS.PRODUCE_NAME
		--, REQ_MAS.ACTIVITY_ID, REQ_MAS.ACTIVITY_NAME
		
		--, REQ_MAS.BUDGET_TYPE_ID, REQ_MAS.BUDGET_TYPE_NAME
		--, (SELECT GOVERNMENT_REFER_CODE FROM T_BUDGET_TYPE_GOVERNMENT_REFER_CODE E WHERE E.BUDGET_TYPE_ID = REQ_MAS.BUDGET_TYPE_ID AND E.YR = @p_fiscal_year) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
		
		--, REQ_MAS.EXPENSES_GROUP_ID, REQ_MAS.EXPENSES_GROUP_NAME
		--, (SELECT GOVERNMENT_REFER_CODE FROM T_EXPENSES_GROUP_GOVERNMENT_REFER_CODE E WHERE E.EXPENSES_GROUP_ID = REQ_MAS.EXPENSES_GROUP_ID AND E.YR = @p_fiscal_year) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE
		
		--, REQ_DETAIL.EXPENSES_ID, REQ_DETAIL.EXPENSES_NAME

		---- ข้อมูลงบประมาณ
		--, CAST(0 AS DECIMAL(20,2)) AS BUDGET_AMOUNT -- เงิน งปม.
		--, CAST(0 AS DECIMAL(20,2)) AS OFF_BUDGET_AMOUNT -- เงินนอก งปม. ตั้งต้น (ไม่สามารถใช้ได้)
		--, CAST(0 AS DECIMAL(20,2)) AS ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอก งปม. ที่สามารถใช้ได้

		---- ข้อมูลการใช้เงิน งปม. และ เงินนอก งปม.
		--, CAST(0 AS DECIMAL(20,2)) AS USE_BUDGET_AMOUNT, CAST(0 AS DECIMAL(20,2)) AS REMAIN_BUDGET_AMOUNT
		--, CAST(0 AS DECIMAL(20,2)) AS USE_OFF_BUDGET_AMOUNT, CAST(0 AS DECIMAL(20,2)) AS REMAIN_OFF_BUDGET_AMOUNT
		
		--, CAST(NULL AS DATETIME) AS LATEST_RECEIVE_BUDGET -- รับเงิน งปม. ล่าสุดเมื่อไหร่
		--, CAST(NULL AS DATETIME) AS LATEST_USE_BUDGET -- ใช้เงิน งปม. ล่าสุดเมื่อไหร่

		--FROM V_GET_BUDGET_REQUEST_INFORMATION REQ_MAS
		--, V_GET_BUDGET_REQUEST_DETAIL_INFORMATION REQ_DETAIL
		--WHERE REQ_MAS.REQ_ID = REQ_DETAIL.REQ_ID
		--  AND REQ_MAS.YR = @p_fiscal_year
		--  AND REQ_MAS.REQ_TYPE = 1 -- เฉพาะคำขอต้นปี
		--;
	--END
GO




/**
 * ค้นหารายการค่าใช้จ่ายที่จัดสรรงบประมาณ เป็นยอดรวม (จากหน้าจอจัดการเงิน งปม./นอก งปม.)
 * เพื่อนำมาบันทึก ยอดเงินงบประมาณ ที่จัดสรรมาเป็นงวดๆ ของรัฐบาล
 * 
**/
IF OBJECT_ID ( 'dbo.proc_GetExpensesIncomeBudgetFromGovernmentByYear', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetExpensesIncomeBudgetFromGovernmentByYear; 
GO
CREATE PROCEDURE proc_GetExpensesIncomeBudgetFromGovernmentByYear @p_fiscal_year SMALLINT
WITH RECOMPILE
AS
	SET NOCOUNT ON;
	SELECT BUDGET_EX.BUDGET_ID, BUDGET_EX.SEQ_ID, BUDGET_EX.YR
	
	, BUDGET_EX.PLAN_ID
	, (SELECT PLAN_NAME FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_NAME
	, (SELECT ORDER_SEQ FROM T_PLAN_CONFIGURE P WHERE P.PLAN_ID = BUDGET_EX.PLAN_ID) AS PLAN_ORDER_SEQ
		
	, BUDGET_EX.PRODUCE_ID
	, (SELECT PRODUCE_NAME FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_NAME
	, (SELECT ORDER_SEQ FROM T_PRODUCE_CONFIGURE P WHERE P.PRODUCE_ID = BUDGET_EX.PRODUCE_ID) AS PRODUCE_ORDER_SEQ
		
	, BUDGET_EX.ACTIVITY_ID
	, (SELECT ACTIVITY_NAME FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_NAME
	, (SELECT ORDER_SEQ FROM T_ACTIVITY_CONFIGURE A WHERE A.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID) AS ACTIVITY_ORDER_SEQ
		
	, BUDGET_EX.BUDGET_TYPE_ID
	, (SELECT BUDGET_TYPE_NAME FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_NAME
	, (SELECT GOVERNMENT_REFER_CODE FROM T_BUDGET_TYPE_GOVERNMENT_REFER_CODE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND YR = @p_fiscal_year) AS BUDGET_TYPE_GOVERNMENT_REFER_CODE
	, (SELECT ORDER_SEQ FROM T_BUDGET_TYPE B WHERE B.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID) AS BUDGET_TYPE_ORDER_SEQ
		
	, BUDGET_EX.EXPENSES_GROUP_ID
	, (SELECT EXPENSES_GROUP_NAME FROM T_EXPENSES_GROUP G WHERE G.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_NAME
	, (SELECT GOVERNMENT_REFER_CODE FROM T_EXPENSES_GROUP_GOVERNMENT_REFER_CODE B WHERE B.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND YR = @p_fiscal_year) AS EXPENSES_GROUP_GOVERNMENT_REFER_CODE
	, (SELECT ORDER_SEQ FROM T_EXPENSES_GROUP G WHERE G.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID) AS EXPENSES_GROUP_ORDER_SEQ
		
	, BUDGET_EX.EXPENSES_ID
	, (SELECT EXPENSES_NAME FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_NAME
	, (SELECT ORDER_SEQ FROM T_EXPENSES_ITEM E WHERE E.EXPENSES_ID = BUDGET_EX.EXPENSES_ID) AS EXPENSES_ORDER_SEQ
	, BUDGET_EX.CAN_ADD_PROJECT

		-- ข้อมูลงบประมาณ
	, BUDGET_EX.BUDGET_AMOUNT -- เงิน งปม. ที่ได้รับจัดสรร
	, BUDGET_EX.ACTUAL_BUDGET_AMOUNT -- เงิน งปม. ประจำงวด (นำไปจัดสรร หรือ เบิกจ่าย)
	, BUDGET_EX.USE_BUDGET_AMOUNT
	, BUDGET_EX.REMAIN_BUDGET_AMOUNT

	, BUDGET_EX.OFF_BUDGET_AMOUNT -- เงินนอก งปม. ตั้งต้น (ไม่สามารถใช้ได้)
	, BUDGET_EX.ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอก งปม. ประจำงวด (นำไปจัดสรร หรือ เบิกจ่าย)
	, BUDGET_EX.USE_OFF_BUDGET_AMOUNT
	, BUDGET_EX.REMAIN_OFF_BUDGET_AMOUNT
		
	, BUDGET_EX.LATEST_RECEIVE_BUDGET -- รับเงิน งปม. ล่าสุดเมื่อไหร่
	, BUDGET_EX.LATEST_USE_BUDGET -- ใช้เงิน งปม. ล่าสุดเมื่อไหร่

	FROM T_BUDGET_EXPENSES BUDGET_EX
	WHERE YR = @p_fiscal_year
	  AND ACTIVE = 1
	;
GO




/**
 * ค้นหารายการโครงการที่ต้องจัดสรรเงินงบประมาณ ไปยังหน่วยงาน
 * 1. ถ้ายังไม่มีรายการจัดสรรโครงการในหน่วยงาน จะดึงจาก รายการโครงการภายใต้ค่าใช้จ่ายส่วนกลาง เป็นค่าเริ่มต้น
 * 2. ถ้ามีการจัดสรรแล้ว ดึงจาก โครงการของหน่วยงาน
**/
IF OBJECT_ID ( 'dbo.proc_GetAllocateProjectBudgetToDepartment', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetAllocateProjectBudgetToDepartment; 
GO 
CREATE PROCEDURE proc_GetAllocateProjectBudgetToDepartment @p_fiscal_year INT
, @p_dep_id INT, @p_plan_id INT, @p_produce_id INT, @p_activity_id INT
, @p_budget_type_id INT, @p_expenses_group_id INT, @p_expenses_id INT
, @p_budget_type INT -- 1 = งบประมาณ, 2 = นอกงบประมาณ
WITH RECOMPILE
AS
	SET NOCOUNT ON;
	
	-- โครงการจาก งบประมาณคงคลังของกรมสรรพสามิต
	SELECT DEP_PROJECT_EX.SEQ_ID
	 , DEP_PROJECT_EX.DEP_ID
	 , DEP_PROJECT_EX.SUB_DEP_ID
	 , PROJECT_EX.YR
	 , PROJECT_EX.PLAN_ID
	 , PROJECT_EX.PRODUCE_ID
	 , PROJECT_EX.ACTIVITY_ID
	 , PROJECT_EX.BUDGET_TYPE_ID
	 , PROJECT_EX.EXPENSES_GROUP_ID
	 , PROJECT_EX.EXPENSES_ID

	 -- โครงการ
	 , PROJECT_EX.PROJECT_ID, PROJECT_EX.PROJECT_NAME
	 , PROJECT_EX.REMAIN_BUDGET_AMOUNT AS BALANCE_BUDGET_AMOUNT
	 , PROJECT_EX.REMAIN_OFF_BUDGET_AMOUNT AS BALANCE_OFF_BUDGET_AMOUNT
	 
	 -- ยอดจัดสรร
	 , DEP_PROJECT_EX.ALLOCATE_BUDGET_AMOUNT
	 , DEP_PROJECT_EX.ALLOCATE_OFF_BUDGET_AMOUNT
	 , DEP_PROJECT_EX.NET_BUDGET_AMOUNT
	 , DEP_PROJECT_EX.USE_BUDGET_AMOUNT
	 , DEP_PROJECT_EX.REMAIN_BUDGET_AMOUNT
	FROM (
		SELECT * 
		FROM T_BUDGET_EXPENSES_PROJECT
		WHERE ACTIVE = 1
		  AND YR = @p_fiscal_year
		  AND PLAN_ID = @p_plan_id
		  AND PRODUCE_ID = @p_produce_id
		  AND ACTIVITY_ID = @p_activity_id
		  AND BUDGET_TYPE_ID = @p_budget_type_id
		  AND EXPENSES_GROUP_ID = @p_expenses_group_id
		  AND EXPENSES_ID = @p_expenses_id
		  AND PROJECT_FOR_TYPE = @p_budget_type -- โครงการจะแยกออกเป็นของแต่ละประเภทงบ ได้แก่ เงินงบประมาณ และ เงินนอกงบประมาณ
	) AS PROJECT_EX
	LEFT OUTER JOIN (SELECT * FROM T_BUDGET_ALLOCATE_EXPENSES WHERE DEP_ID = @p_dep_id AND YR = @p_fiscal_year) AS DEP_PROJECT_EX
	ON(
		PROJECT_EX.YR = DEP_PROJECT_EX.YR AND 
		PROJECT_EX.PLAN_ID = DEP_PROJECT_EX.PROJECT_ID AND 
		PROJECT_EX.PRODUCE_ID = DEP_PROJECT_EX.PROJECT_ID AND 
		PROJECT_EX.ACTIVITY_ID = DEP_PROJECT_EX.ACTIVITY_ID AND 
		PROJECT_EX.BUDGET_TYPE_ID = DEP_PROJECT_EX.BUDGET_TYPE_ID AND 
		PROJECT_EX.EXPENSES_GROUP_ID = DEP_PROJECT_EX.EXPENSES_GROUP_ID AND 
		PROJECT_EX.EXPENSES_ID = DEP_PROJECT_EX.EXPENSES_ID AND 
		PROJECT_EX.PROJECT_ID = DEP_PROJECT_EX.PROJECT_ID
	)


	---- ดึงข้อมูลโครงการของหน่วยงาน
	--SELECT ALLOCATE_EX.SEQ_ID, ALLOCATE_EX.DEP_ID, ALLOCATE_EX.SUB_DEP_ID
	-- , ALLOCATE_EX.YR, ALLOCATE_EX.PLAN_ID, ALLOCATE_EX.PRODUCE_ID, ALLOCATE_EX.ACTIVITY_ID, ALLOCATE_EX.BUDGET_TYPE_ID
	-- , ALLOCATE_EX.EXPENSES_GROUP_ID, ALLOCATE_EX.EXPENSES_ID

	-- -- โครงการ
	-- , ALLOCATE_EX.PROJECT_ID, PROJECT_EX.PROJECT_NAME
	-- , PROJECT_EX.REMAIN_BUDGET_AMOUNT AS BALANCE_BUDGET_AMOUNT
	-- , PROJECT_EX.REMAIN_OFF_BUDGET_AMOUNT AS BALANCE_OFF_BUDGET_AMOUNT
	 
	-- -- งบประมาณรายโครงการของหน่วยงาน
	-- , ALLOCATE_EX.ALLOCATE_BUDGET_AMOUNT, ALLOCATE_EX.ALLOCATE_OFF_BUDGET_AMOUNT
	-- , ALLOCATE_EX.NET_BUDGET_AMOUNT, ALLOCATE_EX.USE_BUDGET_AMOUNT, ALLOCATE_EX.REMAIN_BUDGET_AMOUNT
	--FROM T_BUDGET_ALLOCATE_EXPENSES ALLOCATE_EX
	--	, (SELECT * FROM T_BUDGET_EXPENSES_PROJECT WHERE PROJECT_FOR_TYPE = @p_budget_type) AS PROJECT_EX
	--WHERE ALLOCATE_EX.ACTIVE = 1
	--  AND ALLOCATE_EX.DEP_ID = @p_dep_id
	--  AND ALLOCATE_EX.YR = @p_fiscal_year
	--  AND ALLOCATE_EX.PLAN_ID = @p_plan_id
	--  AND ALLOCATE_EX.PRODUCE_ID = @p_produce_id
	--  AND ALLOCATE_EX.ACTIVITY_ID = @p_activity_id
	--  AND ALLOCATE_EX.BUDGET_TYPE_ID = @p_budget_type_id
	--  AND ALLOCATE_EX.EXPENSES_GROUP_ID = @p_expenses_group_id
	--  AND ALLOCATE_EX.EXPENSES_ID = @p_expenses_id
	  
	--  -- join
	--  AND ALLOCATE_EX.YR = PROJECT_EX.YR
	--  AND ALLOCATE_EX.PLAN_ID = PROJECT_EX.PROJECT_ID
	--  AND ALLOCATE_EX.PRODUCE_ID = PROJECT_EX.PROJECT_ID
	--  AND ALLOCATE_EX.ACTIVITY_ID = PROJECT_EX.ACTIVITY_ID
	--  AND ALLOCATE_EX.BUDGET_TYPE_ID = PROJECT_EX.BUDGET_TYPE_ID
	--  AND ALLOCATE_EX.EXPENSES_GROUP_ID = PROJECT_EX.EXPENSES_GROUP_ID
	--  AND ALLOCATE_EX.EXPENSES_ID = PROJECT_EX.EXPENSES_ID
	--  AND ALLOCATE_EX.PROJECT_ID = PROJECT_EX.PROJECT_ID
	  
	--UNION ALL
	
	---- โครงการจาก งบประมาณคงคลังของกรมสรรพสามิต
	--SELECT CAST(NULL AS INT) AS SEQ_ID
	-- , CAST(NULL AS INT) AS DEP_ID
	-- , CAST(NULL AS INT) AS SUB_DEP_ID
	-- , YR, PLAN_ID, PRODUCE_ID, ACTIVITY_ID, BUDGET_TYPE_ID
	-- , EXPENSES_GROUP_ID, EXPENSES_ID

	-- -- โครงการ
	-- , PROJECT_ID, PROJECT_NAME
	-- , REMAIN_BUDGET_AMOUNT AS BALANCE_BUDGET_AMOUNT
	-- , REMAIN_OFF_BUDGET_AMOUNT AS BALANCE_OFF_BUDGET_AMOUNT
	 
	-- -- ยอดจัดสรร
	-- , CAST(NULL AS DECIMAL(20,2)) AS ALLOCATE_BUDGET_AMOUNT
	-- , CAST(NULL AS DECIMAL(20,2)) AS ALLOCATE_BUDGET_AMOUNT
	-- , CAST(NULL AS DECIMAL(20,2)) AS NET_BUDGET_AMOUNT
	-- , CAST(NULL AS DECIMAL(20,2)) AS USE_BUDGET_AMOUNT
	-- , CAST(NULL AS DECIMAL(20,20)) AS REMAIN_BUDGET_AMOUNT
	--FROM T_BUDGET_EXPENSES_PROJECT BUDGET_EX
	--WHERE ACTIVE = 1
	--  AND YR = @p_fiscal_year
	--  AND PLAN_ID = @p_plan_id
	--  AND PRODUCE_ID = @p_produce_id
	--  AND ACTIVITY_ID = @p_activity_id
	--  AND BUDGET_TYPE_ID = @p_budget_type_id
	--  AND EXPENSES_GROUP_ID = @p_expenses_group_id
	--  AND EXPENSES_ID = @p_expenses_id
	--  AND PROJECT_FOR_TYPE = @p_budget_type
	--  AND NOT EXISTS(
	--	SELECT *
	--	FROM T_BUDGET_ALLOCATE_EXPENSES ALLOCATE_EX
	--	WHERE ALLOCATE_EX.ACTIVE = 1
	--	  AND ALLOCATE_EX.DEP_ID = @p_dep_id
	--	  AND ALLOCATE_EX.YR = @p_fiscal_year
	--	  AND ALLOCATE_EX.YR = BUDGET_EX.YR
	--	  AND ALLOCATE_EX.PLAN_ID = BUDGET_EX.PLAN_ID
	--	  AND ALLOCATE_EX.PRODUCE_ID = BUDGET_EX.PRODUCE_ID
	--	  AND ALLOCATE_EX.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID
	--	  AND ALLOCATE_EX.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID
	--	  AND ALLOCATE_EX.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID
	--	  AND ALLOCATE_EX.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
	--	  AND ALLOCATE_EX.PROJECT_ID = BUDGET_EX.PROJECT_ID
	--  )
	;
GO



/**
 * ค้นหาหน่วยงานทั้งหมด ที่ทำคำขอต้นปี/คำขอเพิ่มเติม และยังไม่จัดสรร
 * 1. ใช้ข้อมูลรายการค่าใช้จ่ายจาก ส่วนกลางเป็นหลัก แยกออกเป็น [คชจ. ที่ไม่มีโครงการภายใต้] และ [คชจ. ที่มีโครงการอยู่ภายใต้]
 * 2. หารายการค่าใช้จ่ายที่ส่งคำของบ ของแต่ล่ะหน่วยงาน มา Map เพื่อให้ทราบว่าหน่วยงานส่งคำของบประมาณ แต่ละรายการ คชจ. เท่าไหร่
 *	2.1 คำขอต้นปี ต้องผ่านการ SignOff มาแล้ว
 *	2.2 ยังไม่จัดสรร
 * ยังไม่รองรับ
 *  หน่วยงานภายนอกมีคำขอรายการ คชจ. นอกเหนือจากที่ส่วนกลางมีรายการ คชจ. ในปีงบประมาณนั้น (ผลลัพธ์ของข้อมูลจะไม่เห็นรายการ คชจ. ของหน่วยงาน)
**/
IF OBJECT_ID ( 'dbo.proc_GetDepartmentRequestBudgetForAllocate', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetDepartmentRequestBudgetForAllocate; 
GO 
CREATE PROCEDURE proc_GetDepartmentRequestBudgetForAllocate @p_fiscal_year INT
, @p_budget_type INT -- 1 = เงิน งปม., 2 = เงินนอก งปม.
, @p_request_type INT -- 1 = คำขอต้นปี, 2 = คำขอเพิ่มเติม
WITH RECOMPILE
AS
	SET NOCOUNT ON;
	
	SELECT BUDGET_EX.*

	-- เงินงบประมาณ และ เงินนอกงบประมาณ ที่จัดสรรให้กับหน่วยงาน
	, ALLOCATE_EX.ALLOCATE_BUDGET_AMOUNT AS DEP_ALLOCATE_EXPENSES_BUDGET_AMOUNT
	, ALLOCATE_EX.ALLOCATE_OFF_BUDGET_AMOUNT AS DEP_ALLOCATE_EXPENSES_OFF_BUDGET_AMOUNT
	FROM(
		SELECT BUDGET_EX.*
		, dbo.fn_GetExpensesGLCodes(BUDGET_EX.EXPENSES_ID) as GLCODEs
		, @p_budget_type as REQUIRED_ALLOCATE_TYPE -- ตอบกลับ ประเภทงบประมาณที่จะจัดสรร (เงินงบ/เงินนอก)
		, @p_request_type as REQUIRED_REQUEST_TYPE -- ตอบกลับ ประเภทคำของบประมาณ (ต้นปี/เพิ่มเติม)

		-- คำขอ ของแต่ละหน่วยงาน
		, BUDGET_REQ.REQ_ID -- เลขที่คำขอ
		, BUDGET_REQ.AREA_ID, BUDGET_REQ.AREA_NAME
		, BUDGET_REQ.DEP_ID, BUDGET_REQ.DEP_NAME, BUDGET_REQ.DEP_CODE -- รหัสหน่วยงานของ ลค.
		, BUDGET_REQ.DEP_SORT_INDEX
		, BUDGET_REQ.BUDGET_TYPE AS REQ_BUDGET_TYPE -- ประเภทเงินงบประมาณที่ขอ (1 = เงินงบ, 2 = นอกงบ)
		, BUDGET_REQ.REQ_TYPE -- ประเภทคำขอ (1 = งบต้นปี, 2 = ขอเพิ่มเติม)
		, BUDGET_REQ.TOTAL_REQUEST_BUDGET AS REQ_BUDGET_AMOUNT -- จำนวนที่ขอเงินงบประมาณ
		, BUDGET_REQ.REQ_MAS_REMARK_TEXT AS REQ_REMARK_TEXT
		FROM
		(
			-- รายการค่าใช้จ่ายของ กรมสรรพสามิต
			SELECT BUDGET_EX.YR
			 , BUDGET_EX.PLAN_ID, PLAN_CONFIG.PLAN_NAME
			 , PLAN_CONFIG.ORDER_SEQ AS PLAN_ORDER_SEQ

			 , BUDGET_EX.PRODUCE_ID, PRODUCE_CONFIG.PRODUCE_NAME
			 , PRODUCE_CONFIG.ORDER_SEQ AS PRODUCE_ORDER_SEQ

			 , BUDGET_EX.ACTIVITY_ID, ACTIVITY_CONFIG.ACTIVITY_NAME
			 , ACTIVITY_CONFIG.SHORT_NAME AS ACTIVITY_SHORT_NAME
			 , ACTIVITY_CONFIG.ORDER_SEQ AS ACTIVITY_ORDER_SEQ

			 , BUDGET_EX.BUDGET_TYPE_ID, BUDGET_TYPE.BUDGET_TYPE_NAME
			 , BUDGET_TYPE.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ

			 , BUDGET_EX.EXPENSES_GROUP_ID, EXPENSES_GROUP.EXPENSES_GROUP_NAME
			 , EXPENSES_GROUP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
			 , EXPENSES_GROUP.ALLOCATE_GROUP_FLAG as EXPENSES_GROUP_ALLOCATE_GROUP_FLAG

			 , BUDGET_EX.EXPENSES_ID, EXPENSES_ITEM.EXPENSES_NAME
			 , EXPENSES_ITEM.ORDER_SEQ AS EXPENSES_ORDER_SEQ

			 , CAST(NULL AS INT) AS PROJECT_ID, CAST(NULL AS NVARCHAR) AS PROJECT_NAME

			 , BUDGET_EX.ACTUAL_BUDGET_AMOUNT AS EXPENSES_ACTUAL_BUDGET_AMOUNT -- เงินงบประมาณประจำงวด สะสม
			 , BUDGET_EX.REMAIN_BUDGET_AMOUNT AS EXPENSES_REMAIN_BUDGET_AMOUNT -- เงินงบประมาณประจำงวด คงเหลือ
			 , BUDGET_EX.ACTUAL_OFF_BUDGET_AMOUNT AS EXPENSES_ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณ จัดเก็บรายได้ สะสม
			 , BUDGET_EX.REMAIN_OFF_BUDGET_AMOUNT AS EXPENSES_REMAIN_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณ จัดเก็บรายได้ คงเหลือ
			FROM (SELECT * FROM T_BUDGET_EXPENSES WHERE ACTIVE = 1 AND YR = @p_fiscal_year) BUDGET_EX
			JOIN T_PLAN_CONFIGURE PLAN_CONFIG ON (PLAN_CONFIG.PLAN_ID = BUDGET_EX.PLAN_ID)
			JOIN T_PRODUCE_CONFIGURE PRODUCE_CONFIG ON(PRODUCE_CONFIG.PRODUCE_ID = BUDGET_EX.PRODUCE_ID)
			JOIN T_ACTIVITY_CONFIGURE ACTIVITY_CONFIG ON(ACTIVITY_CONFIG.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID)
			JOIN T_BUDGET_TYPE BUDGET_TYPE ON(BUDGET_TYPE.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID)
			JOIN T_EXPENSES_GROUP EXPENSES_GROUP ON(EXPENSES_GROUP.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID)
			JOIN T_EXPENSES_ITEM EXPENSES_ITEM ON(EXPENSES_ITEM.EXPENSES_ID = BUDGET_EX.EXPENSES_ID)
			--WHERE ACTIVE = 1 
			-- AND YR = @p_fiscal_year
			 --AND NOT EXISTS(-- รายการ คชจ. ที่ไม่มีโครงการย่อย
				--SELECT * 
				--FROM T_BUDGET_EXPENSES_PROJECT BUDGET_PRO
				--WHERE BUDGET_PRO.PLAN_ID = BUDGET_EX.PLAN_ID
				--  AND BUDGET_PRO.PRODUCE_ID = BUDGET_EX.PRODUCE_ID
				--  AND BUDGET_PRO.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID
				--  AND BUDGET_PRO.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID
				--  AND BUDGET_PRO.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID
				--  AND BUDGET_PRO.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
				--  AND BUDGET_PRO.YR = BUDGET_EX.YR
				--  AND BUDGET_PRO.YR = @p_fiscal_year
				--  AND BUDGET_PRO.ACTIVE = 1
				--  AND BUDGET_PRO.PROJECT_FOR_TYPE = @p_budget_type
			 --)

			UNION ALL

			-- รายการค่าใช้จ่ายของ กรมสรรพสามิต ที่มีโครงการย่อย
			SELECT BUDGET_PRO.YR
			 , BUDGET_PRO.PLAN_ID, PLAN_CONFIG.PLAN_NAME
			 , PLAN_CONFIG.ORDER_SEQ AS PLAN_ORDER_SEQ

			 , BUDGET_PRO.PRODUCE_ID, PRODUCE_CONFIG.PRODUCE_NAME
			 , PRODUCE_CONFIG.ORDER_SEQ AS PRODUCE_ORDER_SEQ

			 , BUDGET_PRO.ACTIVITY_ID, ACTIVITY_CONFIG.ACTIVITY_NAME
			 , ACTIVITY_CONFIG.SHORT_NAME AS ACTIVITY_SHORT_NAME
			 , ACTIVITY_CONFIG.ORDER_SEQ AS ACTIVITY_ORDER_SEQ

			 , BUDGET_PRO.BUDGET_TYPE_ID, BUDGET_TYPE.BUDGET_TYPE_NAME
			 , BUDGET_TYPE.ORDER_SEQ AS BUDGET_TYPE_ORDER_SEQ

			 , BUDGET_PRO.EXPENSES_GROUP_ID, EXPENSES_GROUP.EXPENSES_GROUP_NAME
			 , EXPENSES_GROUP.ORDER_SEQ AS EXPENSES_GROUP_ORDER_SEQ
			 , EXPENSES_GROUP.ALLOCATE_GROUP_FLAG as EXPENSES_GROUP_ALLOCATE_GROUP_FLAG

			 , BUDGET_PRO.EXPENSES_ID, EXPENSES_ITEM.EXPENSES_NAME
			 , EXPENSES_ITEM.ORDER_SEQ AS EXPENSES_ORDER_SEQ

			 , BUDGET_PRO.PROJECT_ID, BUDGET_PRO.PROJECT_NAME

			 , BUDGET_PRO.ACTUAL_BUDGET_AMOUNT AS EXPENSES_ACTUAL_BUDGET_AMOUNT -- เงินงบประมาณประจำงวด สะสม
			 , BUDGET_PRO.REMAIN_BUDGET_AMOUNT AS EXPENSES_REMAIN_BUDGET_AMOUNT -- เงินงบประมาณประจำงวด คงเหลือ
			 , BUDGET_PRO.ACTUAL_OFF_BUDGET_AMOUNT AS EXPENSES_ACTUAL_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณ จัดเก็บรายได้ สะสม
			 , BUDGET_PRO.REMAIN_OFF_BUDGET_AMOUNT AS EXPENSES_REMAIN_OFF_BUDGET_AMOUNT -- เงินนอกงบประมาณ จัดเก็บรายได้ คงเหลือ
			FROM (SELECT * FROM T_BUDGET_EXPENSES_PROJECT WHERE ACTIVE = 1 AND PROJECT_FOR_TYPE = @p_budget_type AND YR = @p_fiscal_year) AS BUDGET_PRO
			JOIN T_PLAN_CONFIGURE PLAN_CONFIG ON (PLAN_CONFIG.PLAN_ID = BUDGET_PRO.PLAN_ID)
			JOIN T_PRODUCE_CONFIGURE PRODUCE_CONFIG ON(PRODUCE_CONFIG.PRODUCE_ID = BUDGET_PRO.PRODUCE_ID)
			JOIN T_ACTIVITY_CONFIGURE ACTIVITY_CONFIG ON(ACTIVITY_CONFIG.ACTIVITY_ID = BUDGET_PRO.ACTIVITY_ID)
			JOIN T_BUDGET_TYPE BUDGET_TYPE ON(BUDGET_TYPE.BUDGET_TYPE_ID = BUDGET_PRO.BUDGET_TYPE_ID)
			JOIN T_EXPENSES_GROUP EXPENSES_GROUP ON(EXPENSES_GROUP.EXPENSES_GROUP_ID = BUDGET_PRO.EXPENSES_GROUP_ID)
			JOIN T_EXPENSES_ITEM EXPENSES_ITEM ON(EXPENSES_ITEM.EXPENSES_ID = BUDGET_PRO.EXPENSES_ID)
		) AS BUDGET_EX

		-- ค้นหารายการค่าใช้จ่ายของแต่ละหน่วยงาน ที่ส่งคำขอต้นปี
		LEFT JOIN (
			SELECT REQ_DETAIL.*, REQ_MAS.BUDGET_TYPE, REQ_MAS.REQ_TYPE, REQ_MAS.REMARK_TEXT AS REQ_MAS_REMARK_TEXT
			, REQ_MAS.AREA_ID, (SELECT AREA_NAME FROM T_AREA AREA WHERE AREA.AREA_ID = REQ_MAS.AREA_ID) AS AREA_NAME
			, DEP.DEP_NAME, DEP.DEP_CODE, DEP.SORT_INDEX AS DEP_SORT_INDEX
			FROM T_BUDGET_REQUEST_MASTER REQ_MAS
			, T_BUDGET_REQUEST_DETAIL REQ_DETAIL
			, T_DEPARTMENT DEP
			WHERE REQ_MAS.REQ_TYPE = @p_request_type -- 1 = คำขอต้นปี, 2 = คำขอเพิ่มเติม
			  AND REQ_MAS.ACTIVE = 1 -- เฉพาะคำขอต้นปี ที่ Active
			  AND REQ_DETAIL.ACTIVE = 1 -- เฉพาะ คชจ. ที่ Active
			  AND REQ_MAS.DEP_ID = DEP.DEP_ID
			  AND (
				 -- กรณีคำขอต้นปี จะต้อง SignOff คำขอแล้ว
				(@p_request_type = 1 AND REQ_MAS.SIGNOFF_FLAG = 1) OR @p_request_type = 2
			  )

			  -- รอจัดสรร
			  AND REQ_MAS.PROCESS_STATUS = 0
			  AND (
				(@p_budget_type = 1 AND REQ_MAS.BUDGET_ALLOCATE_FLAG = 0) OR
				(@p_budget_type = 2 AND REQ_MAS.OFF_BUDGET_ALLOCATE_FLAG = 0)
			  )

			  -- AND REQ_DETAIL.TOTAL_REQUEST_BUDGET > 0 -- เฉพาะ คชจ. ที่ส่งคำขอ
			  AND REQ_MAS.YR = @p_fiscal_year
			  AND REQ_MAS.REQ_ID = REQ_DETAIL.REQ_ID
		) AS BUDGET_REQ
		ON (
			BUDGET_REQ.PLAN_ID = BUDGET_EX.PLAN_ID AND
			BUDGET_REQ.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
			BUDGET_REQ.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
			BUDGET_REQ.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
			BUDGET_REQ.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
			BUDGET_REQ.EXPENSES_ID = BUDGET_EX.EXPENSES_ID
		)
	) AS BUDGET_EX
	-- รายการค่าใช้จ่ายที่จัดสรรให้กับแต่ละหน่วยงาน
	LEFT JOIN (SELECT * FROM T_BUDGET_ALLOCATE_EXPENSES WHERE ACTIVE = 1 AND YR = @p_fiscal_year) as ALLOCATE_EX
	ON(
		ALLOCATE_EX.DEP_ID = BUDGET_EX.DEP_ID AND
		ALLOCATE_EX.YR = BUDGET_EX.YR AND
		ALLOCATE_EX.PLAN_ID = BUDGET_EX.PLAN_ID AND
		ALLOCATE_EX.PRODUCE_ID = BUDGET_EX.PRODUCE_ID AND
		ALLOCATE_EX.ACTIVITY_ID = BUDGET_EX.ACTIVITY_ID AND
		ALLOCATE_EX.BUDGET_TYPE_ID = BUDGET_EX.BUDGET_TYPE_ID AND
		ALLOCATE_EX.EXPENSES_GROUP_ID = BUDGET_EX.EXPENSES_GROUP_ID AND
		ALLOCATE_EX.EXPENSES_ID = BUDGET_EX.EXPENSES_ID AND
		(
			(ALLOCATE_EX.PROJECT_ID = BUDGET_EX.PROJECT_ID) OR 
			(ALLOCATE_EX.PROJECT_ID IS NULL AND BUDGET_EX.PROJECT_ID IS NULL)
		)
	)
GO


/**
 * ค้นหาข้อมูลเมนูที่กำหนดสิทธิ์ให้กับบัญชีผู้ใช้งานแต่ละราย
 * เรียงข้อมูลตาม GROUP_SORT_INDEX, MENU_AUTHORIZE_SORT_INDEX, MENU_SORT_INDEX
 *
**/
IF OBJECT_ID ( 'dbo.proc_GetUserMenu', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetUserMenu; 
GO 
-- EXEC proc_GetUserMenu @p_person_id = 1;
CREATE PROCEDURE proc_GetUserMenu @p_person_id INT
WITH RECOMPILE
AS
	SET NOCOUNT ON;
	SELECT GROUP_ICON, GROUP_NAME, MENU_ICON, MENU_NAME, MENU_DESCRIPTION, MENU_CONST, ROUTE_METHOD, ROUTE_CONTROLLER, QUERY_STRING
	FROM
	(
		SELECT MENU.*, ISNULL(MENU_ROLE.SORT_INDEX, 0) AS MENU_ROLE_SORT_INDEX
		FROM T_PERSONNEL_AUTHORIZE PERSON_ROLE, T_MENU_AUTHORIZE MENU_ROLE,
			(
				SELECT G.GROUP_NAME, ISNULL(G.SORT_INDEX, 0) AS GROUP_SORT_INDEX, G.GROUP_ICON
				, M.MENU_ID, M.MENU_NAME, M.ROUTE_METHOD, M.ROUTE_CONTROLLER
				, M.SORT_INDEX, M.MENU_ICON, M.MENU_CONST, M.MENU_DESCRIPTION, M.QUERY_STRING
				FROM (SELECT * FROM T_MENU WHERE ACTIVE = 1) AS M 
				LEFT JOIN T_GROUP_MENU G 
				ON(G.GROUP_ID = M.GROUP_ID)
			) AS MENU
		WHERE PERSON_ROLE.ROLE_ID = MENU_ROLE.ROLE_ID
		  AND MENU.MENU_ID = MENU_ROLE.MENU_ID
		  AND PERSON_ROLE.ACTIVE = 1
		  AND MENU_ROLE.ACTIVE = 1
		  AND PERSON_ROLE.PERSON_ID = @p_person_id
	) AS FINAL 
	GROUP BY GROUP_ICON, GROUP_NAME, MENU_ICON, MENU_NAME, MENU_DESCRIPTION, MENU_CONST, ROUTE_METHOD, ROUTE_CONTROLLER, QUERY_STRING, GROUP_SORT_INDEX, MENU_ROLE_SORT_INDEX, SORT_INDEX
	ORDER BY GROUP_SORT_INDEX, MENU_ROLE_SORT_INDEX, SORT_INDEX;
GO


/**
 * ค้นหากลุ่มผู้ใช้งานที่กำหนดสิทธิ์ ให้กับแต่ละบัญชี
 *
**/
IF OBJECT_ID ( 'dbo.proc_GetUserRoles', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetUserRoles; 
GO 
-- EXEC proc_GetUserRoles @p_person_id = 1
CREATE PROCEDURE proc_GetUserRoles @p_person_id INT
WITH RECOMPILE
AS
   SELECT USER_ROLE.ROLE_ID, USER_ROLE.ROLE_NAME, USER_ROLE.ROLE_CONST
   FROM T_PERSONNEL_AUTHORIZE PERSON_AUTHORIZE, T_ROLE USER_ROLE
   WHERE PERSON_AUTHORIZE.ACTIVE = 1
     AND PERSON_AUTHORIZE.ROLE_ID = USER_ROLE.ROLE_ID
   ORDER BY USER_ROLE.ROLE_NAME ASC;
GO


/**
 * ค้นหาค่าคงที่ ที่ตั้งค่าไว้ในระบบมาใช้งาน 
 * @p_config_const คือค่าจากตาราง T_CONFIGURATION.CONFIG_CONST
 * หมายเหตุ: การตั้งค่าคงที่ในระบบ จะมีการกำหนดค่าไว้ล่วงหน้า ซึ่งจะมี Effective Date & Expire Date บังคับ
 * ดังนั้น Store นี้จะเป็นการค้นหา ค่าคงที่ ในระบบรายการที่ใช้งานอยู่ ณ ปัจจุบันมาใช้งาน
**/
IF OBJECT_ID ( 'dbo.proc_GetUsingAppConstByKey', 'P' ) IS NOT NULL   
    DROP PROCEDURE dbo.proc_GetUsingAppConstByKey; 
GO 
CREATE PROCEDURE proc_GetUsingAppConstByKey @p_config_const NVARCHAR(100)
WITH RECOMPILE
AS
   SELECT B.CONFIG_ID, B.CONFIG_DETAIL_ID, B.ITEM_VALUE, B.ITEM_VALUE2, B.ITEM_VALUE3, B.EFFECTIVE_DATE, B.EXPIRE_DATE
   FROM V_GET_CURR_CONFIGURATION_USING A, T_CONFIGURATION_DETAIL B
   WHERE A.CONFIG_CONST = @p_config_const
     AND B.ACTIVE = 1
	 AND A.CONFIG_DETAIL_ID = B.CONFIG_DETAIL_ID
   ;
GO